

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" href="/img/icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="windzwindy">
  <meta name="keywords" content="">
  
    <meta name="description" content="Spring 记录（基于 SpringBoot） 1. 通过 ClassPathXmlApplicationContext 类创建 ioc 容器  这个章节是后面补充 类似的可以用其它 xxxApplicationContext 创建 ioc 容器  创建容器  在 src&#x2F;main&#x2F;resources 目录或者其它目录下新建一个名为 spring.xml 的配置文件，其内容如">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring 记录（基于 SpringBoot）">
<meta property="og:url" content="https://windzwindy.github.io/2025/02/23/Spring_Record/index.html">
<meta property="og:site_name" content="WindZwindy Blog">
<meta property="og:description" content="Spring 记录（基于 SpringBoot） 1. 通过 ClassPathXmlApplicationContext 类创建 ioc 容器  这个章节是后面补充 类似的可以用其它 xxxApplicationContext 创建 ioc 容器  创建容器  在 src&#x2F;main&#x2F;resources 目录或者其它目录下新建一个名为 spring.xml 的配置文件，其内容如">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.svg">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A1%A5%E5%85%851.svg">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A1%A5%E5%85%852.svg">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%A1%A5%E5%85%853.svg">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/AOP%E6%9C%AF%E8%AF%AD.svg">
<meta property="og:image" content="https://windzwindy.github.io/images/SSM_Study/Spring%E5%A4%9A%E5%88%87%E9%9D%A2%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.svg">
<meta property="article:published_time" content="2025-02-23T13:10:31.000Z">
<meta property="article:modified_time" content="2025-02-23T13:20:46.861Z">
<meta property="article:author" content="windzwindy">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://windzwindy.github.io/images/SSM_Study/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.svg">
  
  
  
  <title>Spring 记录（基于 SpringBoot） - WindZwindy Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"windzwindy.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":true,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WindZwindy</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring 记录（基于 SpringBoot）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-02-23 21:10" pubdate>
          2025年2月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          19k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          163 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Spring 记录（基于 SpringBoot）</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2025年2月23日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="spring-记录基于-springboot">Spring 记录（基于 SpringBoot）</h1>
<h2 id="通过-classpathxmlapplicationcontext-类创建-ioc-容器">1. 通过
ClassPathXmlApplicationContext 类创建 ioc 容器</h2>
<ul>
<li>这个章节是后面补充</li>
<li>类似的可以用其它 xxxApplicationContext 创建 ioc 容器</li>
</ul>
<h4 id="创建容器">创建容器</h4>
<ul>
<li><p>在 <code>src/main/resources</code> 目录或者其它目录下新建一个名为
<code>spring.xml</code> 的配置文件，其内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>编写 main 方法，查看一下容器中有几个 bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 通过配置文件创建 ioc 容器</span><br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;classpath:spring.xml&quot;</span>);<br><br>        <span class="hljs-comment">// 2. 查看容器中有几个 Bean</span><br>        <span class="hljs-keyword">for</span> (String beanDefinitionName : ioc.getBeanDefinitionNames()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;beanDefinitionName = &quot;</span> + beanDefinitionName);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="给容器放一些-bean">给容器放一些 Bean</h4>
<ul>
<li><p>创建一个 Bean 类，比如 <code>Person.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">private</span> String gender;<br> <br>    <span class="hljs-comment">// constructor</span><br>    <span class="hljs-comment">// getter and setter</span><br>    <span class="hljs-comment">// toString</span><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>编辑 <code>spring.xml</code> 配置文件，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;wind&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.wind.spring.bean.Person&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>上面新增加的代码意思是给容器中放一个 Person 组件，有唯一的 id 为
wind</p></li>
<li><p>再次调用 main 方法构建容器，并查看容器中的 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 通过配置文件创建 ioc 容器</span><br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;classpath:spring.xml&quot;</span>);<br><br>        <span class="hljs-comment">// 2. 查看容器中有几个 Bean</span><br>        <span class="hljs-keyword">for</span> (String beanDefinitionName : ioc.getBeanDefinitionNames()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;beanDefinitionName = &quot;</span> + beanDefinitionName);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到有了一个 wind 的 bean</p></li>
</ul>
<h4 id="给容器中的-bean-属性赋值">给容器中的 bean 属性赋值</h4>
<ul>
<li><p>可以看到，刚才的 Person 类有多个属性，可以给其赋值</p></li>
<li><p>更改 <code>spring.xml</code> 配置文件，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;wind&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.wind.spring.bean.Person&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;widn&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;2*10&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;man&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>其中 value 中的 # 号是 spring 表达式，具体可以看 <code>@Value</code>
注解的用法</p></li>
<li><p>验证是否成功赋值：再次更改 <code>Main.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 通过配置文件创建 ioc 容器</span><br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;classpath:spring.xml&quot;</span>);<br><br>        <span class="hljs-comment">// 2. 查看容器中有几个 Bean</span><br>        <span class="hljs-keyword">for</span> (String beanDefinitionName : ioc.getBeanDefinitionNames()) &#123;<br>            System.out.println(<span class="hljs-string">&quot;beanDefinitionName = &quot;</span> + beanDefinitionName);<br>        &#125;<br>        <br>        <span class="hljs-comment">// 3. 获取组件</span><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> ioc.getBean(Person.class);<br>        System.out.println(<span class="hljs-string">&quot;person = &quot;</span> + person);<br><br>        <span class="hljs-comment">// 或者获取所有的 Person 类组件</span><br>        <span class="hljs-comment">// Map&lt;String, Person&gt; persons = ioc.getBeansOfType(Person.class);</span><br>        <span class="hljs-comment">// System.out.println(&quot;persons = &quot; + persons);</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="批量扫描并添加组件">批量扫描并添加组件</h4>
<ul>
<li><p>太多的组件不想手动配，此时可以在 <code>spring.xml</code> 中用
component-scan 指定批量扫描哪个包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;wind&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.wind.spring.bean.Person&quot;</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;widn&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;2*10&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;man&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--  配置批量扫描  --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;org.wind&quot;</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="注册组件记录">2. 注册组件记录</h2>
<h3 id="注解-bean-记录">注解 <code>@Bean</code> 记录</h3>
<p>用于把一个对象放到 ioc 容器中，名字默认是方法名，可以指定名字</p>
<p>如果名字重复，那么只获取一个的时候按照字母顺序进行获取</p>
<p>这个注解放在方法上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getTest</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br><span class="hljs-meta">@Bean(&quot;test2&quot;)</span><br><span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getTest2</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br></code></pre></td></tr></table></figure>
<p>检验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (String beanDefinitionName : ioc.getBeanDefinitionNames()) &#123;<br> System.out.println(beanDefinitionName);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-configuration-记录">注解 <code>@Configuration</code>
记录</h3>
<p>本质是 <code>@Component</code>，用于标注在类上面：类里面的方法用
<code>@Bean</code> 标注，用 <code>@Configuration</code>
标注的类本身也是一个组件</p>
<p>这个注解放在类上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br> <span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getTest</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br>    <span class="hljs-meta">@Bean(&quot;aaa&quot;)</span><br>    <span class="hljs-keyword">public</span> NewTest <span class="hljs-title function_">getNewTest</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewTest</span>(); &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (String beanDefinitionName : ioc.getBeanDefinitionNames()) &#123;<br> System.out.println(beanDefinitionName);<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-controllerservicerepositorycomponent-记录">注解
<code>@Controller</code>、<code>@Service</code>、<code>@Repository</code>、<code>@Component</code>
记录</h3>
<p>本质上是同一个东西，用于方便区分类的作用</p>
<p><code>@Controller</code> 一般标注在 Controller 类上</p>
<p><code>@Service</code> 一般标注在 Service 类上</p>
<p><code>@Repository</code> 一般标注在 Dao 类上</p>
<p>这几个注解放在类上</p>
<h3 id="注解-componentscan-记录">注解 <code>@ComponentScan</code>
记录</h3>
<p>用于指定扫描包的范围，比如在 org.wind
下写了很多的组件则可以指定范围，这个注解可以写在很多地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(basePackages = &quot;org.wind&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringMain</span>&#123;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-import-记录">注解 <code>Import</code> 记录</h3>
<p>用于导入别人写的类，这个注解可以写在很多地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(Other.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringMain</span>&#123;&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-scope-记录">注解 <code>@Scope</code> 记录</h3>
<p>一般放在 <span class="citation" data-cites="Bean">@Bean</span>
上，默认不写就是 singleton</p>
<ul>
<li>prototype：多实例，需要用的时候才进行实例化</li>
<li>singleton：单实例，容器启动时就完成了实例化</li>
<li>request（不常用）</li>
<li>session（不常用）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfig</span>&#123;<br>    <span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getTest</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-lazy-记录">注解 <code>@Lazy</code> 记录</h3>
<p>要用这个组件时才进行实例化</p>
<p>一般配合 singleten 用，因为 singleton 在容器启动时就实例化了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConfig</span>&#123;<br>    <span class="hljs-meta">@Lazy</span><br>    <span class="hljs-meta">@Scope(&quot;singleton&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getTest</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="接口-factorybeant-记录">接口 FactoryBean&lt;T&gt; 记录</h3>
<p>新建一个 T 类型的组件放到容器中，更灵活地造 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Test&gt; &#123;<br> <span class="hljs-comment">// 返回一个实例</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Test <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>(); &#125;<br>    <span class="hljs-comment">// 返回类型</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123; <span class="hljs-keyword">return</span> Test.class; &#125;<br>    <span class="hljs-comment">// 是单例吗</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-conditional-记录">注解 <code>@Conditional</code> 记录</h3>
<p>判断 <code>@Conditional</code> 指定的 Condition 接口的实现类对象的
matches 方法的返回值，如果是真则创建被 <code>@Conditional</code>
标注的组件，如果是假则不创建</p>
<p>这个注解可以标注在方法和类上</p>
<ul>
<li>负责创建 Bean 的包</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonConfig</span> &#123;<br><br>    <span class="hljs-comment">// 判断 JohnCondition 中的 matches 方法的返回值，真则创建，假则不创建</span><br>    <span class="hljs-meta">@Conditional(JohnCondition.class)</span><br>    <span class="hljs-meta">@Bean(&quot;john&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">john</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;John&quot;</span>);<br>        person.setAge(<span class="hljs-number">20</span>);<br>        person.setGender(<span class="hljs-string">&quot;man&quot;</span>);<br>        <span class="hljs-keyword">return</span> person;<br>    &#125;<br><br>    <span class="hljs-comment">// 判断 JohnCondition 中的 matches 方法的返回值，真则创建，假则不创建</span><br>    <span class="hljs-meta">@Conditional(PaulCondition.class)</span><br>    <span class="hljs-meta">@Bean(&quot;paul&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">paul</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;paul&quot;</span>);<br>        person.setAge(<span class="hljs-number">20</span>);<br>        person.setGender(<span class="hljs-string">&quot;man&quot;</span>);<br>        <span class="hljs-keyword">return</span> person;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>判断条件的包（实现 Condition 接口的类）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.condition;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JohnCondition</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>又</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.condition;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaulCondition</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>很明显只会创建一个名为 paul 的 Person 类实例</p>
<ul>
<li>Condition 接口有很多派生类，可以直接用</li>
</ul>
<h2 id="注入组件记录">3. 注入组件记录</h2>
<h3 id="注解-autowired-记录">注解 <code>@Autowired</code> 记录</h3>
<p><code>@Autowired</code> 注解可以用在属性、setter方法上</p>
<p><code>@Autowired</code> 注解可以用来注入==非简单类型==</p>
<p>默认按照类型在容器中找实现类，注入</p>
<p>如果找到多个，再按照变量名去找，注入，如果变量名找不到，报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.controller;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    Person wind;<br>    <br>    <span class="hljs-comment">// 拿到所有的 Person 类型组件</span><br>    <span class="hljs-meta">@Autowired</span><br>    List&lt;Person&gt; personList;<br>    <br>    <span class="hljs-comment">// 拿到所有的 Person 类型组件，并以组件名为 map 的 key</span><br>    <span class="hljs-meta">@Autowired</span><br>    Map&lt;String, Person&gt; personMap;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>标注在 setter 方法上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.dao;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br> Cat cat;<br><br>    <span class="hljs-comment">//@Autowired</span><br>    <span class="hljs-comment">//public void setCat(Cat cat) &#123;</span><br>    <span class="hljs-comment">//    this.cat = cat;</span><br>    <span class="hljs-comment">//&#125;</span><br>    <br>    <span class="hljs-comment">// 如果容器中有多个组件，可以用 @Qualifier 指定名称</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCat</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;mycat&quot;)</span> Cat cat)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cat = cat;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>其中可以指定 required 属性，如果为
false，那么在容器中找不相应的组件，就为 null，不报错</li>
</ul>
<h3 id="注解-primary-和-qualifier-记录">注解 <code>@Primary</code> 和
<code>@Qualifier</code> 记录</h3>
<h4 id="primary"><code>@Primary</code></h4>
<p>配合 <span class="citation" data-cites="Autowired">@Autowired</span>
注解使用，用于指定默认用的组件</p>
<p>当 <span class="citation" data-cites="Autowired">@Autowired</span>
注入时有多个同类型的组件可以注入，此时不知道注入哪一个，如果在注册组件时用
<span class="citation" data-cites="Primary">@Primary</span>
标注了组件，那么尽管有多个同类型的组件可以注入，<span class="citation"
data-cites="Autowired">@Autowired</span> 也会优先选择带有 <span
class="citation" data-cites="Primary">@Primary</span> 的组件</p>
<ul>
<li>注册组件时，有多个同类型组件，用 <span class="citation"
data-cites="Primary">@Primary</span> 指定默认注入的组件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonConfig</span> &#123;<br>    <br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean(&quot;wind&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">wind</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;wind&quot;</span>); &#125;<br>    <br>    <span class="hljs-meta">@Bean(&quot;windzwindy&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">windzwindy</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;windzwindy&quot;</span>); &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>注入时</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br> <br>    <span class="hljs-meta">@Autowired</span><br>    Person person;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="qualifier"><code>@Qualifier</code></h4>
<p>配合 <span class="citation" data-cites="Autowired">@Autowired</span>
注解使用，用于指定装配的组件名称</p>
<p>当 <span class="citation" data-cites="Autowired">@Autowired</span>
注入时有多个同类型的组件可以注入，不知道注入哪一个，此时就用 <span
class="citation" data-cites="Qualifier">@Qualifier</span>
指定要注入的组件名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br> <br>    <span class="hljs-meta">@Qualifier(&quot;wind&quot;)</span><br>    <span class="hljs-meta">@Autowired</span><br>    Person person;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>==如果 <span class="citation"
data-cites="Qualifier">@Qualifier</span> 和 <span class="citation"
data-cites="Primary">@Primary</span> 同时用，按 <span class="citation"
data-cites="Qualifier">@Qualifier</span> 指定的组件名称来==</p>
<h3 id="注解-resource-记录">注解 <span class="citation"
data-cites="Resource">@Resource</span> 记录</h3>
<ul>
<li><p>这个注解是 jakarta 规定的，而 <span class="citation"
data-cites="AutoWired">@AutoWired</span> 是 Spring 规定的</p></li>
<li><p>这个注解也是自动注入的功能，默认按照属性名去容器中找对应组件名进行注入</p></li>
<li><p>如果找不到与属性名相应的组件名，那么就会按照属性类型去容器中找相应组件类型进行注入</p></li>
<li><p><span class="citation" data-cites="Autowired">@Autowired</span>
默认按照的是类型，如果要想按名字匹配，还要和 <span class="citation"
data-cites="Qualifier">@Qualifier</span> 配合</p></li>
<li><p><span class="citation" data-cites="Resource">@Resource</span>
注解没有像 <span class="citation"
data-cites="Autowired">@Autowired</span> 注解的 required
相关属性</p></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    UserDao userDao;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="有参构造器注入记录">有参构造器注入记录</h3>
<ul>
<li>指定一个有参构造器，不用注解就可以自动注入</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.dao;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br> Cat cat;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDao</span><span class="hljs-params">(Cat cat)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cat = cat;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="aware-接口记录">Aware 接口记录</h3>
<p>Spring 中有一个 Aware 接口（感知接口），并且有许多接口继承于它</p>
<p>有一个组件在容器中，这个组件实现了 xxxAware（感知接口），Spring
在调用这个组件时，会自动调用感知接口中的方法，如果方法有参数，则会在容器中找到相应的组件传进去，只需要要写方法就好了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanNameAware</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String myname;<br><br>    <span class="hljs-comment">// 这个方法是感知接口 BeanNameAware 中的，其中 name 会自动传进来</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.myname = name;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMyname</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.myname;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySpringApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> SpringApplication.run(MySpringApplication.class, args);<br><br>        <span class="hljs-type">MyComponent</span> <span class="hljs-variable">mycomponent</span> <span class="hljs-operator">=</span> ioc.getBean(MyComponent.class);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">myname</span> <span class="hljs-operator">=</span> mycomponent.getMyname();<br>        System.out.println(<span class="hljs-string">&quot;myname = &quot;</span> + myname);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="注解-value-记录">注解 <code>@Value</code> 记录</h3>
<p><code>@Autowired</code> 注解是用来自动注入组件的，基本类型要用
<code>@Value</code> 注解</p>
<h4 id="第一种用法直接赋值">第一种用法：直接赋值</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>&#123;<br>    <br>    <span class="hljs-meta">@Value(&quot;wind&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-meta">@Value(&quot;20&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>以上代码，将一个名为 Person
的组件放进容器中，当从容器中取的时候，它的属性 name 为 wind
，它的属性age 为 20</p>
<h4
id="第二种用法valuexxxdefault动态取值从配置文件中取">第二种用法：<code>@Value("$&#123;xxx:default&#125;")</code>，动态取值，从配置文件中取</h4>
<p>默认从 <code>src\main\resources\application.properties</code>
文件中取，如果想在其他配置文件中取，需要用 <code>@PropertySource</code>
注解</p>
<p>比如刚好在 <code>src\main\resources</code>
文件夹下有一个配置文件：<code>application.properties</code></p>
<p>里面的内容为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">person.name</span>=<span class="hljs-string">windziwndy</span><br><span class="hljs-attr">person.age</span>=<span class="hljs-string">18</span><br></code></pre></td></tr></table></figure>
<p>对应的动态取值代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>&#123;<br>    <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.age&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果配置文件中没有配置相应的值，但又在 <span class="citation"
data-cites="Value">@Value</span>
中去取，此时可以加个冒号，在冒号的后面指定默认值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>&#123;<br>    <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.age&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.gender:&#x27;man&#x27;&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String gender;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h4
id="第三种用法valuespelspring-表达式">第三种用法：<code>@Value("#&#123;SpEL&#125;")</code>，<a
target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/expressions.html">Spring
表达式</a></h4>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>&#123;<br>    <br>    <span class="hljs-meta">@Value(&quot;#&#123;T(java.util.UUID).randomUUID().toString()&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String id;<br>    <br>    <span class="hljs-meta">@Value(&quot;#&#123;new String(\&quot;wind\&quot;)&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-meta">@Value(&quot;#&#123;2*10&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>那么从容器中取 Person 组件时，属性 id 是一个 UUID 属性 name 为 wind
发展 age 为 20</p>
<h3 id="注解-propertysource-记录">注解 <code>@PropertySource</code>
记录</h3>
<p>拓展指定属性来源</p>
<p>当用 <span class="citation" data-cites="Value">@Value</span>
注解动态从配置文件中取值的时值，如果不想从
<code>application.properties</code> 配置文件中取，则可以用 <span
class="citation" data-cites="PropertySource">@PropertySource</span>
注解指定在哪个配置文件中取</p>
<p>比如刚好在 <code>src\main\resources</code>
文件夹下有一个配置文件：<code>person.properties</code></p>
<p>里面的内容为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">person.name</span>=<span class="hljs-string">wind</span><br><span class="hljs-attr">person.age</span>=<span class="hljs-string">20</span><br></code></pre></td></tr></table></figure>
<p>取值代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// @PropertySource(&quot;file:/path/xxx&quot;)</span><br><span class="hljs-comment">// @PropertySource(&quot;classpath*:/xxx&quot;) // 查找所有类路径，导入别人包的配置文件时可以用</span><br><span class="hljs-meta">@PropertySource(&quot;classpath:/person.properties&quot;)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>&#123;<br>    <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-meta">@Value(&quot;$&#123;person.age&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>注意：用了这个注解后指定属性配置文件后，依然可以在
<code>application.properties</code> 中取值</p>
<h3 id="resourceutils-工具类记录">ResourceUtils 工具类记录</h3>
<p>通过代码方式获取资源，并进行一系列文件流的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> ResourceUtils.getFile(<span class="hljs-string">&quot;classpath:person.properties&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>支持的前缀有很多种，可以进源码看一下</p>
<h3 id="注解-profile-记录">注解 <code>@Profile</code> 记录</h3>
<p>本质是一个 <span class="citation"
data-cites="Conditional">@Conditional</span> 注解</p>
<p>根据不同的环境，启用不同环境相对应的组件，例如：数据源的注入，开发时用一个数据源，发布时用另一个数据源，此时就可以用到
<span class="citation" data-cites="Profile">@Profile</span> 注解了</p>
<p>如何指定环境：在配置文件 <code>application.properties</code>
中激活相应的环境，例如激活 myenv 环境</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.profiles.active</span>=<span class="hljs-string">myenv</span><br></code></pre></td></tr></table></figure>
<p>无论有没有在配置文件中指定环境，都会有一个名为 <code>default</code>
的环境，即默认环境</p>
<p>代码示例：</p>
<ul>
<li><p>Spring 配置文件：<code>application.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.profiles.active</span>=<span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure></li>
<li><p>数据源类：<code>DataSource.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.datasource;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSource</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String url;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <br>    <span class="hljs-comment">// constructor</span><br>    <span class="hljs-comment">// getter and setter</span><br>    <span class="hljs-comment">// toString</span><br>    <span class="hljs-comment">// ...</span><br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>数据源配置类：<code>DataSourceConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> &#123;<br><br>    <span class="hljs-comment">// 开发环境用</span><br>    <span class="hljs-meta">@Profile(&quot;dev&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">dev</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>();<br>        DataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/dev&quot;</span>);<br>        DataSource.setUsername(<span class="hljs-string">&quot;dev_user&quot;</span>);<br>        DataSource.setPassword(<span class="hljs-string">&quot;dev_password&quot;</span>);<br>        <span class="hljs-keyword">return</span> myDataSource;<br>    &#125;<br><br>    <span class="hljs-comment">// 生产环境用</span><br>    <span class="hljs-meta">@Profile(&quot;prod&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">prod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>();<br>        DataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/prod&quot;</span>);<br>        DataSource.setUsername(<span class="hljs-string">&quot;prod_user&quot;</span>);<br>        DataSource.setPassword(<span class="hljs-string">&quot;prod_password&quot;</span>);<br>        <span class="hljs-keyword">return</span> myDataSource;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>持久层类，做一些数据操作：<code>UserDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.dao;<br><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br>    <span class="hljs-comment">// 注意，此处会注入 dev 组件，因为上面的配置文件中激活了 dev 环境</span><br>    <span class="hljs-comment">// 而 prod 组件只在 prod 环境才生效</span><br>    <span class="hljs-meta">@Autowired</span><br>    DataSource dataSource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">search</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 此处仅模拟做一此操作</span><br>        System.out.println(dataSource + <span class="hljs-string">&quot;searching...&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>注意：如果上面的配置文件中没有指定激活的环境，那么就是
<code>default</code> 环境，因为没有指定 <code>default</code>
环境用哪一个 <code>DataSource</code> 组件，所以用
<code>@Autowired</code> 自动注入就会找不到 <code>DataSource</code>
组件而报错，这时可以在指定多个环境去解决，修改数据源配置类：<code>DataSourceConfig.java</code>
中的 <code>@Profile</code>
注解，指定环境为一个数组，这样以防报错，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> &#123;<br><br>    <span class="hljs-comment">// 开发环境用，如果没有指定任何环境，即 default 环境，也用这个数据源</span><br>    <span class="hljs-meta">@Profile(&#123;&quot;dev&quot;, &quot;default&quot;&#125;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">dev</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>();<br>        DataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/dev&quot;</span>);<br>        DataSource.setUsername(<span class="hljs-string">&quot;dev_user&quot;</span>);<br>        DataSource.setPassword(<span class="hljs-string">&quot;dev_password&quot;</span>);<br>        <span class="hljs-keyword">return</span> myDataSource;<br>    &#125;<br><br>    <span class="hljs-comment">// 生产环境用</span><br>    <span class="hljs-meta">@Profile(&quot;prod&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MyDataSource <span class="hljs-title function_">prod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">myDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDataSource</span>();<br>        DataSource.setUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/prod&quot;</span>);<br>        DataSource.setUsername(<span class="hljs-string">&quot;prod_user&quot;</span>);<br>        DataSource.setPassword(<span class="hljs-string">&quot;prod_password&quot;</span>);<br>        <span class="hljs-keyword">return</span> myDataSource;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="组件bean的生命周期记录">4. 组件（Bean）的生命周期记录</h2>
<h3 id="bean-注解的-initmethod-和-destroymethod-方法记录">1. <span
class="citation" data-cites="Bean">@Bean</span> 注解的 initMethod 和
destroyMethod 方法记录</h3>
<ul>
<li><p>创建一个 Bean
类：<code>User.java</code>，留两个方法研究生命周期</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <br>    <span class="hljs-keyword">private</span> Car car;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCar</span><span class="hljs-params">(Car car)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;自动注入：&quot;</span> + car);<br>        <span class="hljs-built_in">this</span>.car = car;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;User 构造器...&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 初始化&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 销毁&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>创建配置类，往容器中放一个 User
组件，并指定初始化方法和销毁方法：<code>UserConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean(initMethod = &quot;initUser&quot;, destroyMethod = &quot;destroyUser&quot;)</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">user</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试：<code>Main.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> SpringApplication.run(Main.class, args);<br>        System.out.println(<span class="hljs-string">&quot;ioc create finished........................&quot;</span>);<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> ioc.getBean(User.class);<br>        System.out.println(<span class="hljs-string">&quot;bean = &quot;</span> + bean);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>流程大致如下：</p>
<figure>
<img src="/images/SSM_Study/bean生命周期.svg" srcset="/img/loading.gif" lazyload alt="bean生命周期" />
<figcaption aria-hidden="true">bean生命周期</figcaption>
</figure>
<h3 id="实现-initializingbean-disposablebean-接口的生命周期user.java">2.
实现 InitializingBean, DisposableBean
接口的生命周期：<code>User.java</code></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span>, DisposableBean &#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> Car car;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCar</span><span class="hljs-params">(Car car)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;自动注入：&quot;</span> + car);<br>        <span class="hljs-built_in">this</span>.car = car;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;User 构造器...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 初始化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 销毁&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;destroy&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>流程补充：</p>
<figure>
<img src="/images/SSM_Study/bean生命周期补充1.svg" srcset="/img/loading.gif" lazyload
alt="bean生命周期补充1" />
<figcaption aria-hidden="true">bean生命周期补充1</figcaption>
</figure>
<h3 id="注解-postconstruct-和-predestroy-记录user.java">3. 注解 <span
class="citation" data-cites="PostConstruct">@PostConstruct</span> 和
<span class="citation" data-cites="PreDestroy">@PreDestroy</span>
记录：<code>User.java</code></h3>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span>, DisposableBean &#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> Car car;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCar</span><span class="hljs-params">(Car car)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;自动注入：&quot;</span> + car);<br>        <span class="hljs-built_in">this</span>.car = car;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;User 构造器...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 初始化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroyUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;@Bean 销毁&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postConstruct</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;PostConstruct execute&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preDestroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;PreDestroy execute&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;destroy&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>流程补充：</p>
<figure>
<img src="/images/SSM_Study/bean生命周期补充2.svg" srcset="/img/loading.gif" lazyload
alt="bean生命周期补充2" />
<figcaption aria-hidden="true">bean生命周期补充2</figcaption>
</figure>
<h3 id="接口-beanpostprocessor-的记录后置处理器">4. 接口
BeanPostProcessor 的记录（后置处理器）</h3>
<p>用于做所有 Bean 的实例化、配置和初始化后实现一些自定义逻辑，所有的
Bean 都会拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.processor;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <br>    <span class="hljs-comment">// 初始化前做后置处理</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(beanName + <span class="hljs-string">&quot;postProcessBeforeInitialization&quot;</span>);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化后做后置处理</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(beanName + <span class="hljs-string">&quot;postProcessAfterInitialization&quot;</span>);<br><br>        <span class="hljs-comment">// 如果拦截到的是 User 则做一些修改，否则原样返回</span><br>        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> User user) &#123;<br>            user.setUsername(<span class="hljs-string">&quot;test&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>流程补充：</p>
<figure>
<img src="/images/SSM_Study/bean生命周期补充3.svg" srcset="/img/loading.gif" lazyload
alt="bean生命周期补充3" />
<figcaption aria-hidden="true">bean生命周期补充3</figcaption>
</figure>
<p>例子：给带有 UUID 注解的属性自动注入一个
UUID：<code>UUIDMethod.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.processor;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UUIDMethod</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br> <br>    <span class="hljs-meta">@SneakyThrows</span> <span class="hljs-comment">// lombok 注解，可以免写抛异常语句</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">// 获取类的所有属性</span><br>        Field[] fields = bean.getClass().getDeclaredFields();<br>        <span class="hljs-comment">// 对所有属性进行遍历</span><br>        <span class="hljs-keyword">for</span> (Field field : fields) &#123;<br>            <span class="hljs-comment">// 如果属性有一个 UUID 注解，和这个属性是一个字符串类型才进行注入</span><br>            <span class="hljs-keyword">if</span> (field.isAnnotationPresent(UUID.class) &amp;&amp; field.getType().equals(String.class)) &#123;<br>                <span class="hljs-comment">// 设置属性为可访问</span><br>                field.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 生成 UUID</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> java.util.UUID.randomUUID().toString();<br>                <span class="hljs-comment">// 设置属性值</span><br>                field.set(bean, s)<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="aop-面向切面编程记录">5. AOP 面向切面编程记录</h2>
<h3 id="代理模式记录">代理模式记录</h3>
<p>代理模式，对目标类进行包装</p>
<p>在代码实现上，包括两种形式：</p>
<h4
id="静态代理在编码期间就决定好代理关系容易出现类爆炸">静态代理：在编码期间就决定好代理关系，容易出现类爆炸</h4>
<p>目标类和代理类一定是公共接口的实现类，否则就不叫包装了，代理模式有点功能拓展的意思，如果不是公共接口的实现类，那么想调用目标类的方法，有可能出现代理类对象中没有，所以要有一个公共接口去约束目标类和代理类</p>
<p>公共接口：<code>Work.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.work;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Work</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>目标类：<code>WorkImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.work.impl;<br><br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.Work;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Work</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">// 真正核心逻辑方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Working ...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>代理类：<code>WorkStaticProxy.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.proxy.statics;<br><br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.Work;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkStaticProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Work</span> &#123;<br><br>    <span class="hljs-comment">// 有一个目标对象，用于调用其方法</span><br>    Work target;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkStaticProxy</span><span class="hljs-params">(Work mc)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = mc;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 做一些功能在调用之前</span><br>        System.out.println(<span class="hljs-string">&quot;before work&quot;</span>);<br>        <br>        <span class="hljs-comment">// 调用目标对象中方法（真正需要的方法）</span><br>        <span class="hljs-built_in">this</span>.target.work();<br>        <br>        <span class="hljs-comment">// 做一些功能在调用之后</span><br>        System.out.println(<span class="hljs-string">&quot;after work&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试：<code>StaticProxyTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop;<br><br><span class="hljs-keyword">import</span> org.wind.spring.aop.proxy.statics.WorkStaticProxy;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.Work;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.impl.WorkImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticProxyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Work</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkImpl</span>();<br>        <span class="hljs-comment">// 直接调用目标类的方法，可以和下面对比</span><br>        target.work();<br><br>        System.out.println(<span class="hljs-string">&quot;===========================&quot;</span>);<br><br>        <span class="hljs-type">Work</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkStaticProxy</span>(target);<br>        <span class="hljs-comment">// 调用代理类的方法</span><br>        proxy.work();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4
id="动态代理在运行期间才决定好代理关系">动态代理：在运行期间才决定好代理关系</h4>
<ul>
<li><p>JDK动态代理技术（只能接口代理）</p>
<p>上面的：公共接口，代理类，目标类都不变</p>
<p>测试：<code>DynamicProxyTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop;<br><br><span class="hljs-keyword">import</span> org.wind.spring.aop.proxy.statics.WorkStaticProxy;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.Work;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.work.impl.WorkImpl;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicProxyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 1. 原生对象</span><br>        <span class="hljs-type">Work</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkImpl</span>();<br>        <span class="hljs-comment">// 直接调用目标类的方法，可以和下面对比</span><br>        target.work();<br><br>        System.out.println(<span class="hljs-string">&quot;===========================&quot;</span>);<br><br>        <span class="hljs-comment">// InvocationHandler 普通写法</span><br>        <span class="hljs-comment">/*InvocationHandler invocationHandler = new InvocationHandler() &#123;</span><br><span class="hljs-comment">            @Override</span><br><span class="hljs-comment">            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="hljs-comment">                return null;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        &#125;;*/</span><br><br>        <span class="hljs-comment">// lambda 表达式写法</span><br>        <span class="hljs-comment">/*InvocationHandler invocationHandler = (Object proxy, Method method, Object[] args) -&gt; &#123;</span><br><span class="hljs-comment">            return null;</span><br><span class="hljs-comment">        &#125;;*/</span><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * ClassLoader loader,  类加载器（目标对象）</span><br><span class="hljs-comment">         * Class&lt;?&gt;[] interfaces,  目标对象实现的接口</span><br><span class="hljs-comment">         * InvocationHandler h,  处理器接口（函数式接口，可以用 lambda 表达式）先运行这里的 invoke 方法，</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-comment">// 2. 创建动态代理</span><br><br>        <span class="hljs-comment">// 普通写法</span><br>        <span class="hljs-comment">//Object proxy = Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), invocationHandler);</span><br><br>        <span class="hljs-comment">// 一步写法</span><br>        <span class="hljs-type">Work</span> <span class="hljs-variable">proxyInstance</span> <span class="hljs-operator">=</span> (Work) Proxy.newProxyInstance(<br>                target.getClass().getClassLoader(),<br>                target.getClass().getInterfaces(),<br>                (Object proxy, Method method, Object[] args) -&gt; &#123;<br><br>                    <span class="hljs-comment">// 调用前做一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;before invoke&quot;</span>);<br><br>                    <span class="hljs-comment">// 调用目标方法</span><br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);<br><br>                    <span class="hljs-comment">// 调用后做一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;after invoke&quot;</span>);<br><br>                    <span class="hljs-comment">// 返回（目标方法返回的结果）</span><br>                    <span class="hljs-keyword">return</span> result;<br>                &#125;);<br>        proxyInstance.work();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以把上面的代码提出来，就可以方便对任何类进行包装（动态代理）了</p>
<p>工具类：<code>DynamicProxy.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.proxy.dynamic;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicProxy</span> &#123;<br>    <span class="hljs-comment">// 传一个目标类进来，返回一个代理对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<br>                target.getClass().getClassLoader(),<br>                target.getClass().getInterfaces(),<br>                (proxy, method, args) -&gt; &#123;<br>                    <span class="hljs-comment">// 在调用目标对象方法前，进行一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;before proxy execute ...&quot;</span>);<br>                    <span class="hljs-comment">// 调用目标对象方法</span><br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);<br>                    <span class="hljs-comment">// 在调用目标对象方法后，进行一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;after proxy execute ...&quot;</span>);<br>                    <span class="hljs-keyword">return</span> result;<br>                &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>工具再次改进：<code>DynamicProxy.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.proxy.dynamic;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicProxy</span> &#123;<br>    <span class="hljs-comment">// 传一个目标类进来，返回一个代理对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<br>                target.getClass().getClassLoader(),<br>                target.getClass().getInterfaces(),<br>                (proxy, method, args) -&gt; &#123;<br>                    <span class="hljs-comment">// 在调用目标对象方法前，进行一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;before proxy execute ...&quot;</span>);<br>                    <br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">// 调用目标对象方法</span><br>                        result = method.invoke(target, args);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        <span class="hljs-comment">// 异常处理</span><br>                        System.out.println(<span class="hljs-string">&quot;错误信息：&quot;</span> + e.getMessage());<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        System.out.println(<span class="hljs-string">&quot;结束&quot;</span>);<br>                    &#125;<br>                    <br>                    <span class="hljs-comment">// 在调用目标对象方法后，进行一些操作</span><br>                    System.out.println(<span class="hljs-string">&quot;after proxy execute ...&quot;</span>);<br>                    <span class="hljs-keyword">return</span> result;<br>                &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>CGLIB动态代理技术</p></li>
<li><p>Javassist动态代理技术</p></li>
</ul>
<h3 id="aop-专业术语">AOP 专业术语</h3>
<ul>
<li>学习于 <code>杜聚宾</code> 与 <code>雷丰阳</code> 老师</li>
</ul>
<p>连接点（JoinPoint）：可以进行织入通知的地方</p>
<p>切入点（PointCut）：真正织入通知的地方</p>
<p>通知（Advice）：要织入的代码</p>
<p>切面类（Aspect）：里面有多个通知，<strong>切面=通知+连接点</strong></p>
<p>织入（Weave）：把通知添加到目标对象上的过程</p>
<p>目标对象（Target）：被织入的对象</p>
<p>代理对象（Proxy）：织入后的对象（新对象）</p>
<figure>
<img src="/images/SSM_Study/AOP术语.svg" srcset="/img/loading.gif" lazyload alt="AOP专业术语" />
<figcaption aria-hidden="true">AOP专业术语</figcaption>
</figure>
<h3 id="spring-aop-编写记录">Spring AOP 编写记录</h3>
<p>参照官方文档：<a
target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/aop.html">Aspect
Oriented Programming with Spring :: Spring Framework</a></p>
<ul>
<li><p>有一个目标类 <code>PeopleImpl.java</code> 实现了
<code>People.java</code> 接口：</p>
<ul>
<li><p>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.people;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">(String foodName)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>目标类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.people.impl;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.people.People;<br><br><span class="hljs-meta">@Component</span> <span class="hljs-comment">// 放进容器中</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;working...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">(String foodName)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;eating &quot;</span> + foodName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>创建一个测试类，用于测试：<code>AOPTest</code>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.people.People;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AOPTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    People people;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(people);<br>        people.work();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>如果我想用 Spring 的 AOP
为上面的类加一个日志功能如何做？</p></li>
<li><p>第一步：先在 <code>pom.xml</code> 文件中导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>第二步：要有一个切面类：<code>LogAspect.java</code></p></li>
<li><p>第三步：切面类中写通知方法</p></li>
<li><p>第四步：给通知方法指定切入点表达式</p></li>
<li><p>注意：</p>
<ul>
<li>切面类要用 <code>@Aspect</code> 注解，表明这是一个切面</li>
<li>切面类也要放进 ioc 容器中，否则无法使用</li>
<li>里面写很多个方法，这些个方法就是通知（Advice）</li>
<li>给通知方法指定切入点表达式
<ul>
<li>在方法执行的什么时候进行通知？用下面四个注解指定</li>
<li>在什么方法上进行通知？用切入点表达式指定</li>
</ul></li>
<li>此处有四个常用注解，每个注解都需要一个切入点表达式：
<ul>
<li><code>@Before</code> ：在执行方法前进行通知</li>
<li><code>@AfterReturning</code>
：在方法正常返回后进行通知（注意与下面的 <code>@After</code>
注解进行区分）</li>
<li><code>@AfterThrowing</code> ：在发生异常后进行通知</li>
<li><code>@After</code> ：方法执行后进行通知，不管正常异常返回</li>
</ul></li>
<li>切入点表达式基本写法，用中括号的都可以不写：<code>execution([方法访问控制修饰符] 方法返回值类型 [全类名]+方法名(参数类型) [throws 异常类名])</code>
<ul>
<li>方法名如果为 <code>*</code> 号，则表示所有方法，方法参数用
<code>..</code> 表示任意数量参数，包名用 <code>..</code>
表示多个层级的包</li>
<li>匹配所有方法<code>execution(* *(..))</code>，一般不会用
<ul>
<li>例如：</li>
<li><code>execution(public void org.wind.spring.aop.people.People.work())</code></li>
<li><code>execution(public void org.wind.spring.aop.people.People.eat(String))</code></li>
<li><code>execution(void work())</code></li>
<li><code>execution(void eat(String))</code></li>
<li><code>execution(void *())</code></li>
<li><code>"execution(public void org.wind.spring.aop.people.People.*(..))"</code></li>
</ul></li>
</ul></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br><br>    <span class="hljs-meta">@Before(&quot;execution(public void org.wind.spring.aop.people.People.work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志开始...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...&quot;</span>);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再次运行测试程序，发现已经有日志了，代表切面成功织入了</p></li>
<li><p>可以打印一下对象的类型：</p></li>
<li><p>修改测试类：<code>AOPTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.people.People;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AOPTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    People people;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> &#123;<br>        <br>        System.out.println(people.getClass()); <span class="hljs-comment">// 这里打印一下对象的类型</span><br>        <br>        people.work();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>发现后面是<code>$$SpringCGLIB$$0</code>结尾，即是代理对象</p></li>
</ul>
<h4 id="注解-aspect-记录">注解 <code>@Aspect</code> 记录</h4>
<p>表示这是一个切面类</p>
<h4 id="注解-before-记录">注解 <code>@Before</code> 记录</h4>
<p>在指定的目标类方法执行之前进行通知</p>
<h4 id="注解-afterreturning-记录">注解 <code>@AfterReturning</code>
记录</h4>
<p>在指定的目标类方法正常返回后进行通知</p>
<p>这个注解有一个参数 <code>returning</code> 用于指定返回值：</p>
<p>如果通知方法有两个参数，请注意顺序：JoinPoint 参数在前 Object
参数在后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterReturning(value = &quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;, returning = &quot;result&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="注解-afterthrowing-记录">注解 <code>@AfterThrowing</code>
记录</h4>
<p>在指定的目标类方法发生异常进行通知</p>
<p>这个注解有一个参数 <code>throwing</code> 用于指定异常对象</p>
<p>如果通知方法有两个参数，请注意顺序：JoinPoint 参数在前 Exception
参数在后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterThrowing(value = &quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;, throwing = &quot;e&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;日志异常...，异常信息&quot;</span> + e.getMessage());<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="注解-after-记录">注解 <code>@After</code> 记录</h4>
<p>在指定的目标类方法执行之后进行通知，不论是否发生异常都会通知，与上面的
<code>@AfterReturning</code> 不一样</p>
<h4 id="注解-around-记录">注解 <code>@Around</code> 记录</h4>
<ul>
<li><p>即环绕通知时用</p></li>
<li><p>前面的“前置通知、返回通知、异常通知、后置通知”都只是感知，不能修改目标方法的参数、返回值等</p></li>
<li><p>“环绕通知”可以控制目标方法是否执行，修改目标方法参数
、执行结果等</p></li>
<li><p>被 <code>@Around</code> 注解的方法有下面要求：</p>
<ul>
<li><p>The method should declare <code>Object</code> as its return type,
and the first parameter of the method must be of type
<code>ProceedingJoinPoint</code>.Within the body of the advice method,
you must invoke <code>proceed()</code> on the
<code>ProceedingJoinPoint</code> in order for the underlying method to
run. Invoking <code>proceed()</code> without arguments will result in
the caller’s original arguments being supplied to the underlying method
when it is invoked. For advanced use cases, there is an overloaded
variant of the <code>proceed()</code> method which accepts an array of
arguments (<code>Object[]</code>). The values in the array will be used
as the arguments to the underlying method when it is invoked.</p>
<ul>
<li>返回值类型为：<code>Object</code></li>
<li>第一个参数类型为：<code>ProceedingJoinPoint</code></li>
<li>在方法体内要执行 <code>ProceedingJoinPoint</code> 的
<code>proceed()</code>
方法，方法可以传参数，参数类型为：<code>Object[]</code></li>
</ul></li>
</ul></li>
<li><p>环绕通知示例，切面代码：<code>AroundAspect.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AroundAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* org.wind.spring.aop.people.People.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    ;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 环绕通知有固定写法，如下：</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-meta">@Around(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>        <span class="hljs-comment">// 获取目标方法的参数</span><br>        Object[] args = joinPoint.getArgs();<br><br>        <span class="hljs-comment">// 方法前做事情，即前置通知了</span><br>        System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 前置通知&quot;</span>);<br><br>        <span class="hljs-comment">//Object result = joinPoint.proceed(args); // 类似于反射中的 method.invoke();</span><br><br>        <span class="hljs-comment">// 如果想做异常通知则：捕获异常做</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 类似于反射中的 method.invoke();</span><br>            result = joinPoint.proceed(args);<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 返回通知&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;e.getMessage() = &quot;</span> + e.getMessage());<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 异常通知&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 无论正常异常都会有通知，即后置通知</span><br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 后置通知&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 也可以在这里做返回通知</span><br>        <span class="hljs-comment">//System.out.println(&quot;【环绕通知】 -- 返回通知&quot;);</span><br><br>        <span class="hljs-comment">// 可以修改返回结果</span><br>        <span class="hljs-keyword">return</span> result;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="切入点表达式写法记录">切入点表达式写法记录</h4>
<ul>
<li><p>参照官方文档：<a
target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html">Declaring
a Pointcut :: Spring Framework</a></p></li>
<li><p>切入点表达式基本写法，用中括号的都可以不写：<code>execution([方法访问控制修饰符] 方法返回值类型 [全类名]+方法名(参数类型) [throws 异常类名])</code></p>
<ul>
<li><p>方法名如果为 <code>*</code> 号，则表示所有方法，方法参数用
<code>..</code> 表示任意数量参数，包名用 <code>..</code>
表示多个层级的包</p></li>
<li><p>匹配所有方法<code>execution(* *(..))</code>，一般不会用</p>
<ul>
<li>例如：</li>
<li><code>execution(public void org.wind.spring.aop.people.People.work())</code></li>
<li><code>execution(public void org.wind.spring.aop.people.People.eat(String))</code></li>
<li><code>execution(void work())</code></li>
<li><code>execution(void eat(String))</code></li>
<li><code>execution(void *())</code></li>
<li><code>"execution(public void org.wind.spring.aop.people.People.*(..))"</code></li>
</ul></li>
</ul></li>
<li><p><strong><code>execution</code></strong>：用于匹配方法执行连接点，最常用</p>
<ul>
<li>例子：
<ul>
<li><p><code>execution(public * *(..))</code></p></li>
<li><p><code>execution(* set*(..))</code></p></li>
<li><p><code>execution(* com.xyz.service.AccountService.*(..))</code></p></li>
<li><p><code>execution(* com.xyz.service.*.*(..))</code></p></li>
<li><p><code>execution(* com.xyz.service..*.*(..))</code></p></li>
</ul></li>
</ul></li>
<li><p><code>within</code>：匹配指定类型内（包括子类型）的所有连接点，例子：</p>
<ul>
<li>类型 <code>com.xyz.service</code>
下所有类和子包下的类的方法都进行切面：
<ul>
<li><code>within(com.xyz.service..*)</code></li>
</ul></li>
<li>类型 <code>com.xyz.service</code> 下所有类的方法都进行切面：
<ul>
<li><code>within(com.xyz.service.*)</code></li>
</ul></li>
</ul></li>
<li><p><code>this</code>：匹配代理对象是指定类型或其子类型的任何连接点，例子：</p>
<ul>
<li>实现了 <code>com.xyz.service.AccountService</code>
接口的代理对象下的所有方法都进行切面：
<ul>
<li><code>this(com.xyz.service.AccountService)</code></li>
</ul></li>
</ul></li>
<li><p><code>target</code>：匹配目标对象是指定类型或其子类型的任何连接点，例子：</p>
<ul>
<li>实现了 <code>com.xyz.service.AccountService</code>
接口的目标对象下的所有方法都进行切面：
<ul>
<li><code>target(com.xyz.service.AccountService)</code></li>
</ul></li>
</ul></li>
<li><p><strong><code>args</code></strong>：匹配方法参数是指定类型或其子类型的任何连接点（比较常用），例子：</p>
<ul>
<li>匹配方法参数有一个且类型为：<code>java.io.Serializable</code>的方法进行切面：</li>
<li><code>args(java.io.Serializable)</code></li>
</ul></li>
<li><p><code>bean</code>：匹配特定 Spring Bean 的所有连接点，这依赖于
Spring Bean 的名称或 ID，例子：</p>
<ul>
<li>匹配 Bean 的 name 是 <code>tradeService</code>
的组件，为其下所有方法进行切面：</li>
<li><code>bean(tradeService)</code></li>
<li>匹配 Bean 的 name 是以 <code>Service</code>
结尾的组件，为其下所有方法进行切面：
<ul>
<li><code>bean(*Service)</code></li>
</ul></li>
</ul></li>
<li><p><code>@target</code>：匹配标注了指定注解的所有目标对象的方法，例子：</p>
<ul>
<li>匹配目标对象上带有 <code>@Transactional</code>
注解的对象，为其下所有方法进行切面：
<ul>
<li><code>@target(org.springframework.transaction.annotation.Transactional)</code></li>
</ul></li>
</ul></li>
<li><p><code>@args</code>：匹配方法参数标注指定注解，例子：</p>
<ul>
<li>匹配方法参数上带有 <code>@Classified</code>
注解的方法，为其进行切面：
<ul>
<li><code>@args(com.xyz.security.Classified)</code></li>
</ul></li>
</ul></li>
<li><p><code>@within</code>：匹配目标对象类型上拥有指定注解的所有方法，例子：</p>
<ul>
<li>匹配目标对象上带有 <code>@Transactional</code>
的对象，为其下所有方法进行切面：
<ul>
<li><code>@within(org.springframework.transaction.annotation.Transactional)</code></li>
</ul></li>
</ul></li>
<li><p><strong><code>@annotation</code></strong>：匹配任何被指定注解标注的方法，例子：</p>
<ul>
<li>匹配带有<code>@Transactional</code> 注解的方法，为其进行切面：
<ul>
<li><code>@annotation(org.springframework.transaction.annotation.Transactional)</code></li>
</ul></li>
</ul></li>
</ul>
<h4 id="增强器链记录">增强器链记录</h4>
<ul>
<li>切面中的所有方法其实就是增强器，他们被组织成一个链路放到集合中，目标方法真正执行前后，会去增强器链中执行那些需要提前执行的方法</li>
<li>打个断点，运行测试程序，点开代理对象，有一个
<code>DynamicAdvisedInterceptor</code> 点开它，有一个
<code>advised</code> 再点开，有一个 <code>advisors</code>
里面就是一堆增强器</li>
<li>AOP 的底层原理（面试？）
<ul>
<li>1、Spring 会为每个被切面切入的组件创建代理对象（Spring CGLIB
创建的代理对象）</li>
<li>2、代理对象中保存了切面类里面所有通知方法构成的增强器链</li>
<li>3、目标方法执行时，会先去执行增强器链中拿到需要提前执行的通知方法去执行</li>
</ul></li>
</ul>
<h4 id="通知方法的执行顺序记录">通知方法的执行顺序记录</h4>
<ul>
<li>正常执行顺序：
<ul>
<li>前置通知（<code>@Before</code>） -&gt; 目标方法 -&gt;
返回通知（<code>@AfterReturning</code>） -&gt;
后置通知（<code>@After</code>）</li>
</ul></li>
<li>不正常执行顺序
<ul>
<li>前置通知（<code>@Before</code>） -&gt; 目标方法 -&gt;
异常通知（<code>@AfterThrowing</code>） -&gt;
后置通知（<code>@After</code>）</li>
</ul></li>
</ul>
<h4 id="joinpoint-连接点信息获取">JoinPoint 连接点信息获取</h4>
<ul>
<li><p>即然都做日志通知了，但是不知道为哪个目标方法做的通知（方法名），不知道目标方法的参数有哪些，也不知道目标方法的返回值是什么，所以这时候需要一个能获取连接点信息的东西，即
<code>org.aspectj.lang.JoinPoint</code></p></li>
<li><p>通知方法的返回值，访问限定符无要求，但是方法的参数不能随便写，可以写一个
<code>org.aspectj.lang.JoinPoint</code>
类型参数用于获取方法名，方法参数等：<code>LogAspect.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br><br>    <span class="hljs-meta">@Before(&quot;execution(public void org.wind.spring.aop.people.People.work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...&quot;</span>);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<p>再次运行测试程序</p></li>
<li><p>获取目标方法的返回值，在注解 <code>@AfterReturning</code> 中的
<code>returning</code> 参数指定：<code>LogAspect.java</code></p></li>
<li><p>如果通知方法有两个参数，请注意顺序：JoinPoint 参数在前 Object
参数在后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br><br>    <span class="hljs-meta">@Before(&quot;execution(public void org.wind.spring.aop.people.People.work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>    &#125;<br><br><br>    <span class="hljs-meta">@AfterThrowing(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...&quot;</span>);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>程序发生异常时，获取异常的信息，在注解
<code>@AfterThrowing</code> 中的 <code>throwing</code>
参数指定：<code>LogAspect.java</code></p></li>
<li><p>如果通知方法有两个参数，请注意顺序：JoinPoint 参数在前 Exception
参数在后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br><br>    <span class="hljs-meta">@Before(&quot;execution(public void org.wind.spring.aop.people.People.work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;execution(public void work())&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>    &#125;<br><br><br>    <span class="hljs-meta">@AfterThrowing(value = &quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;, throwing = &quot;e&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...，异常信息&quot;</span> + e.getMessage());<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="注解-pointcut-记录">注解 <code>@Pointcut</code> 记录</h4>
<ul>
<li><p>为了实现切入点表达式的复用：可以用 <code>@Pointcut</code>
注解，用法：在任意一个方法上加上注解，注解里面指定切入点表达式，然后在需要用切入点表达式的注解上写入方法名即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 定义</span><br><span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br><span class="hljs-comment">// 用法</span><br><span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br><span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br><span class="hljs-meta">@AfterReturning(&quot;pointcut()&quot;)</span><br><span class="hljs-meta">@AfterThrowing(&quot;pointcut()&quot;)</span><br></code></pre></td></tr></table></figure></li>
<li><p>可以再次更改 <code>LogAspect.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br>    <br>    <span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;pointcut()&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>    &#125;<br><br><br>    <span class="hljs-meta">@AfterThrowing(value = &quot;pointcut()&quot;, throwing = &quot;e&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...，异常信息&quot;</span> + e.getMessage());<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="注解-order-记录">注解 <code>@Order</code> 记录</h4>
<ul>
<li><p>如果有多个切面，那么切面通知的执行顺序是怎么样的呢？</p></li>
<li><p>切面 <code>LogAspect.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br>    <br>    <span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;pointcut()&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>    &#125;<br><br><br>    <span class="hljs-meta">@AfterThrowing(value = &quot;pointcut()&quot;, throwing = &quot;e&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...，异常信息&quot;</span> + e.getMessage());<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>切面 <code>AuthAspect.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth Before Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Returning Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowing</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Throwing Method&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>运行测试程序得出结论：如果不指定顺序默认按照切面类的类名字母排序进行从外到内地切面通知，有点类似于
Filter 和 Interceptor，流程图如下：</p>
<figure>
<img src="/images/SSM_Study/Spring多切面执行顺序.svg" srcset="/img/loading.gif" lazyload
alt="Spring多切面执行顺序" />
<figcaption aria-hidden="true">Spring多切面执行顺序</figcaption>
</figure></li>
<li><p>该如何指定切面的顺序呢？可以用 <code>@Order</code>
注解指定：数字越小，优先级越高</p></li>
<li><p>切面加 <code>@Order</code> 注解：<code>LogAspect.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-meta">@Order(1)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> &#123;<br>    <br>    <span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 1. 拿到方法的全签名</span><br>        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();<br>        <span class="hljs-comment">// 获取目标方法名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> signature.getName();<br>        <span class="hljs-comment">// 目标方法传来的参数值</span><br>        Object[] args = joinPoint.getArgs();<br>        System.out.println(<span class="hljs-string">&quot;日志开始...，方法名：&quot;</span> + name + <span class="hljs-string">&quot;参数列表：&quot;</span>+ Arrays.toString(args));<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志结束...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;pointcut()&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志返回...，目标方法返回结果为：&quot;</span> + result);<br>    &#125;<br><br><br>    <span class="hljs-meta">@AfterThrowing(value = &quot;pointcut()&quot;, throwing = &quot;e&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Throwable e)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;日志异常...，异常信息&quot;</span> + e.getMessage());<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>切面加 <code>@Order</code> 注解：<code>AuthAspect.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Order(2)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(public void org.wind.spring.aop.people.People.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span>&#123;&#125;;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth Before Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Returning Method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowing</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Auth After Throwing Method&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="spring-三级缓存分析记录如何获取-bean-实例">Spring
三级缓存分析记录：如何获取 Bean 实例</h4>
<ul>
<li><p>先写一个组件接口：<code>People.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.people;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再写一个组件，实现组件接口，并放到容器中：<code>PeopleImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.people.impl;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.annotation.MyAn;<br><span class="hljs-keyword">import</span> org.wind.spring.aop.people.People;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;working...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>写个主程序，或者测试程序，加断点进行测试（&gt;&gt;&gt;即是打断点），这里直接主程序：<code>SpringAOPApplication.java</code></p></li>
<li><p>断点打到获取 Bean 的地方，启动 Debug 模式，Step Into</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">package</span> org.wind.spring.aop;<br><br> <span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br> <span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br> <span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext;<br> <span class="hljs-keyword">import</span> org.wind.spring.aop.people.impl.PeopleImpl;<br><br> <span class="hljs-meta">@SpringBootApplication</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAOPApplication</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>   <span class="hljs-comment">// 创建初始化容器...</span><br>   <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> SpringApplication.run(SpringAOPApplication.class, args);<br>   <br>   <span class="hljs-comment">// 获取 Bean 断点打这里</span><br>   <span class="hljs-comment">// Step Into</span><br>&gt;&gt;&gt;   <span class="hljs-type">PeopleImpl</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> ioc.getBean(PeopleImpl.class);<br>   <br>   <span class="hljs-comment">// 打印 Bean</span><br>   System.out.println(bean);<br>  &#125;<br><br> &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Into
后发现打开了一个新的类：<code>AbstractApplicationContext.java</code></p></li>
<li><p>调用了其中的
<code>public &lt;T&gt; T getBean(Class&lt;T&gt; requiredType) throws BeansException;</code>
方法</p></li>
<li><p>方法里又调用了另一个类中的方法</p></li>
<li><p>再 Step Into</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br>  <br> <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>  <span class="hljs-comment">// 方法进入到这里，没有获取到 Bean 对象，Step Over</span><br>  assertBeanFactoryActive();<br>  <span class="hljs-comment">// 下面的方法 Step Over 后就有了 Bean 了，所以一定在下面的方法获取到了 Bean</span><br>  <span class="hljs-comment">// 所以 Step Into 进入 getBean 方法</span><br>  <span class="hljs-keyword">return</span> getBeanFactory().getBean(requiredType);<br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>此时又打开了一个新的类：<code>DefaultListableBeanFactory.java</code></p></li>
<li><p>调用了当前类中的重载方法：<code>public &lt;T&gt; T getBean(Class&lt;T&gt; requiredType, @Nullable Object... args) throws BeansException;</code></p></li>
<li><p>然后在方法中又调用了另一个方法，方法仍在当前类中：<code>private &lt;T&gt; T resolveBean(ResolvableType requiredType, @Nullable Object[] args, boolean nonUniqueAsNull);</code></p></li>
<li><p>对这个方法 Step Over 后发现获取到了 Bean，所以应该 Step Into
这个方法</p></li>
<li><p>在这个方法里，又调用了另一个方法，方法仍在当前类中：<code>private &lt;T&gt; NamedBeanHolder&lt;T&gt; resolveNamedBean(ResolvableType requiredType, @Nullable Object[] args, boolean nonUniqueAsNull) throws BeansException;</code></p></li>
<li><p>对这个方法 Step Over 后发现获取到了 Bean，所以应该 Step Into
这个方法，可以在这个方法前打个断点，重新 Debug 运行到下一个断点</p></li>
<li><p>在方法 <code>resolveNamedBean</code> 中根据类型获取 Bean
的名字，再判断条件：再调用 <code>resolveNamedBean</code> 重载方法，当
Step Over 后发现获取到了 Bean，此时应该 Step Into 这个方法</p></li>
<li><p>进去发现调用了 <code>getBean</code> 方法，Step Over 后就获取到了
Bean，所以应该再进去：Step Into</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAutowireCapableBeanFactory</span><br>   <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableListableBeanFactory</span>, BeanDefinitionRegistry, Serializable &#123;<br>    <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>   <span class="hljs-comment">// 方法进入到了这里，Step Over 后就有了 Bean 所以一定在下面的方法获取到了 Bean</span><br>   <span class="hljs-comment">// 再次调用这个类下面的一个 getBean 方法，进去看一看 Step Into</span><br>   <span class="hljs-keyword">return</span> getBean(requiredType, (Object[]) <span class="hljs-literal">null</span>);<br>  &#125;<br>  <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object... args)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>   <span class="hljs-comment">// 来到了这里，下一步 Step Over</span><br>   Assert.notNull(requiredType, <span class="hljs-string">&quot;Required type must not be null&quot;</span>);<br>   <br>   <span class="hljs-comment">// 这里调用了 resolveBean 方法，这个方法还在这个类中</span><br>   <span class="hljs-comment">// Step Over 后有了 Bean</span><br>   <span class="hljs-comment">// 所以 Step Into 进去这个方法</span><br>   <span class="hljs-type">Object</span> <span class="hljs-variable">resolved</span> <span class="hljs-operator">=</span> resolveBean(ResolvableType.forRawClass(requiredType), args, <span class="hljs-literal">false</span>);<br>   <br>   <span class="hljs-keyword">if</span> (resolved == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchBeanDefinitionException</span>(requiredType);<br>   &#125;<br>   <span class="hljs-keyword">return</span> (T) resolved;<br>  &#125;<br>  <br>  <span class="hljs-meta">@Nullable</span><br>  <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">resolveBean</span><span class="hljs-params">(ResolvableType requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> nonUniqueAsNull)</span> &#123;<br>   <br>   <span class="hljs-comment">// 下一步调用了 resolveNamedBean 方法，这个方法在这个类中</span><br>   <span class="hljs-comment">// Step Over 后就有了 Bean</span><br>   <span class="hljs-comment">// 所以 Step Into 进去，可以在这里打一个断点，方便调试</span><br>&gt;&gt;&gt;   NamedBeanHolder&lt;T&gt; namedBean = resolveNamedBean(requiredType, args, nonUniqueAsNull);<br><br>   <span class="hljs-keyword">if</span> (namedBean != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> namedBean.getBeanInstance();<br>   &#125;<br>   <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br>   <span class="hljs-keyword">if</span> (parent <span class="hljs-keyword">instanceof</span> DefaultListableBeanFactory dlfb) &#123;<br>    <span class="hljs-keyword">return</span> dlfb.resolveBean(requiredType, args, nonUniqueAsNull);<br>   &#125;<br>   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>    ObjectProvider&lt;T&gt; parentProvider = parent.getBeanProvider(requiredType);<br>    <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br>     <span class="hljs-keyword">return</span> parentProvider.getObject(args);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>     <span class="hljs-keyword">return</span> (nonUniqueAsNull ? parentProvider.getIfUnique() : parentProvider.getIfAvailable());<br>    &#125;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <br>  <span class="hljs-meta">@Nullable</span><br>  <span class="hljs-keyword">private</span> &lt;T&gt; NamedBeanHolder&lt;T&gt; <span class="hljs-title function_">resolveNamedBean</span><span class="hljs-params">(</span><br><span class="hljs-params">    ResolvableType requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> nonUniqueAsNull)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>   <span class="hljs-comment">// 方法来到了这里，Step Over</span><br>   Assert.notNull(requiredType, <span class="hljs-string">&quot;Required type must not be null&quot;</span>);<br>   <br>   <span class="hljs-comment">// 这里调用了 getBeanNamesForType 方法（仍在当前类中），根据类型找 Bean</span><br>   <span class="hljs-comment">// 这就是为什么 Spring 先根据类型找 Bean</span><br>   <span class="hljs-comment">// Step Over</span><br>   String[] candidateNames = getBeanNamesForType(requiredType);<br><br>   <span class="hljs-comment">// 找到名字了，没有拿到 Bean</span><br>   <span class="hljs-comment">// 名字只有一个，下面 if 条件不成立，继续 Step Over</span><br>   <span class="hljs-keyword">if</span> (candidateNames.length &gt; <span class="hljs-number">1</span>) &#123;<br>    List&lt;String&gt; autowireCandidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(candidateNames.length);<br>    <span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br>     <span class="hljs-keyword">if</span> (!containsBeanDefinition(beanName) || getBeanDefinition(beanName).isAutowireCandidate()) &#123;<br>      autowireCandidates.add(beanName);<br>     &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!autowireCandidates.isEmpty()) &#123;<br>     candidateNames = StringUtils.toStringArray(autowireCandidates);<br>    &#125;<br>   &#125;<br><br>   <span class="hljs-comment">// 这个条件成立了，再 Step Over 执行 return 语句方法结束，就拿到 Bean 了</span><br>   <span class="hljs-comment">// 下面这个方法仍然在当前类中</span><br>   <span class="hljs-comment">// 所以一定是在下面的方法获取到了 Bean</span><br>   <span class="hljs-comment">// 所以 Step Into，可以在这里打一个断点，方便调试</span><br>   <span class="hljs-keyword">if</span> (candidateNames.length == <span class="hljs-number">1</span>) &#123;<br>&gt;&gt;&gt;    <span class="hljs-keyword">return</span> resolveNamedBean(candidateNames[<span class="hljs-number">0</span>], requiredType, args);<br>   &#125;<br>   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidateNames.length &gt; <span class="hljs-number">1</span>) &#123;<br>    Map&lt;String, Object&gt; candidates = CollectionUtils.newLinkedHashMap(candidateNames.length);<br>    <span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br>     <span class="hljs-keyword">if</span> (containsSingleton(beanName) &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> getBean(beanName);<br>      candidates.put(beanName, (beanInstance <span class="hljs-keyword">instanceof</span> NullBean ? <span class="hljs-literal">null</span> : beanInstance));<br>     &#125;<br>     <span class="hljs-keyword">else</span> &#123;<br>      candidates.put(beanName, getType(beanName));<br>     &#125;<br>    &#125;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">candidateName</span> <span class="hljs-operator">=</span> determinePrimaryCandidate(candidates, requiredType.toClass());<br>    <span class="hljs-keyword">if</span> (candidateName == <span class="hljs-literal">null</span>) &#123;<br>     candidateName = determineHighestPriorityCandidate(candidates, requiredType.toClass());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (candidateName != <span class="hljs-literal">null</span>) &#123;<br>     <span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> candidates.get(candidateName);<br>     <span class="hljs-keyword">if</span> (beanInstance == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>     &#125;<br>     <span class="hljs-keyword">if</span> (beanInstance <span class="hljs-keyword">instanceof</span> Class) &#123;<br>      <span class="hljs-keyword">return</span> resolveNamedBean(candidateName, requiredType, args);<br>     &#125;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedBeanHolder</span>&lt;&gt;(candidateName, (T) beanInstance);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!nonUniqueAsNull) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoUniqueBeanDefinitionException</span>(requiredType, candidates.keySet());<br>    &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <br>  <span class="hljs-meta">@Nullable</span><br>  <span class="hljs-keyword">private</span> &lt;T&gt; NamedBeanHolder&lt;T&gt; <span class="hljs-title function_">resolveNamedBean</span><span class="hljs-params">(</span><br><span class="hljs-params">    String beanName, ResolvableType requiredType, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>   <span class="hljs-comment">// 方法来到了这里</span><br>   <span class="hljs-comment">// 执行 Step Over 后就有 Bean 了，所以一定在这个方法里</span><br>   <span class="hljs-comment">// 所以 Step Into，可以在这里打一个断点，方便调试</span><br>   <span class="hljs-comment">// 执行这个方法后打开了一个新的类</span><br>&gt;&gt;&gt;   <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(beanName, <span class="hljs-literal">null</span>, args);<br>   <br>   <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> NullBean) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedBeanHolder</span>&lt;&gt;(beanName, adaptBeanInstance(beanName, bean, requiredType.toClass()));<br>  &#125;<br>  <br> &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>打开了 <code>AbstractBeanFactory</code> 类，调用了
<code>public &lt;T&gt; T getBean(String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object... args) throws BeansException;</code>
方法，里面只有一个 <code>doGetBean</code> 方法，再进去 Step
Into</p></li>
<li><p>再 Step Over 到调用新的类中的 <code>getSingleton</code>
方法后就获取到了 Bean，所以应该 Step Into</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> &#123;<br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object... args)</span><br>    <span class="hljs-keyword">throws</span> BeansException &#123;<br>   <br>   <span class="hljs-comment">// 方法来到了这里</span><br>   <span class="hljs-comment">// Step Into 进去看一看</span><br>   <span class="hljs-comment">// 调用的方法仍然在当前类中</span><br>   <span class="hljs-keyword">return</span> doGetBean(name, requiredType, args, <span class="hljs-literal">false</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span><br><span class="hljs-params">    String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span><br>    <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>   <span class="hljs-comment">// 方法来到了这里，transformedBeanName 转换 name 为 BeanName</span><br>   <span class="hljs-comment">// Step Over 到下面 getSingleton 方法</span><br>   <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);<br>   Object beanInstance;<br><br>   <span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span><br>   <span class="hljs-comment">// 来到了这里，再 Step Over 发现就获取到了 Bean</span><br>   <span class="hljs-comment">// 所以 Step Into 进去，打开一个新的类，可以在这里打一个断点，方便调试</span><br>&gt;&gt;&gt;   <span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br><br>   <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>     <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +<br>        <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>     &#125;<br>     <span class="hljs-keyword">else</span> &#123;<br>      logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>     &#125;<br>    &#125;<br>    beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);<br>   &#125;<br><br>   <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Fail if we&#x27;re already creating this bean instance:</span><br>    <span class="hljs-comment">// We&#x27;re assumably within a circular reference.</span><br>    <span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);<br>    &#125;<br><br>    <span class="hljs-comment">// Check if bean definition exists in this factory.</span><br>    <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();<br>    <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br>     <span class="hljs-comment">// Not found -&gt; check parent.</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> originalBeanName(name);<br>     <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory abf) &#123;<br>      <span class="hljs-keyword">return</span> abf.doGetBean(nameToLookup, requiredType, args, typeCheckOnly);<br>     &#125;<br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// Delegation to parent with explicit args.</span><br>      <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>     &#125;<br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br>      <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>     &#125;<br>     <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>     &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>     markBeanAsCreated(beanName);<br>    &#125;<br><br>    <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanCreation</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.beans.instantiate&quot;</span>)<br>      .tag(<span class="hljs-string">&quot;beanName&quot;</span>, name);<br>    <span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>      beanCreation.tag(<span class="hljs-string">&quot;beanType&quot;</span>, requiredType::toString);<br>     &#125;<br>     <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>     checkMergedBeanDefinition(mbd, beanName, args);<br><br>     <span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>     String[] dependsOn = mbd.getDependsOn();<br>     <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br>       <span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>          <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>       &#125;<br>       registerDependentBean(dep, beanName);<br>       <span class="hljs-keyword">try</span> &#123;<br>        getBean(dep);<br>       &#125;<br>       <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>          <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>       &#125;<br>       <span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>        <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// Wrap exception with current bean metadata but only if specifically</span><br>         <span class="hljs-comment">// requested (indicated by required type), not for depends-on cascades.</span><br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>           <span class="hljs-string">&quot;Failed to initialize dependency &#x27;&quot;</span> + ex.getBeanName() + <span class="hljs-string">&quot;&#x27; of &quot;</span> +<br>             requiredType.getSimpleName() + <span class="hljs-string">&quot; bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> +<br>             ex.getMessage(), ex);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> ex;<br>       &#125;<br>      &#125;<br>     &#125;<br><br>     <span class="hljs-comment">// Create bean instance.</span><br>     <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>      sharedInstance = getSingleton(beanName, () -&gt; &#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>       &#125;<br>       <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>        <span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br>        <span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br>        <span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>        destroySingleton(beanName);<br>        <span class="hljs-keyword">throw</span> ex;<br>       &#125;<br>      &#125;);<br>      beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>     &#125;<br><br>     <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>      <span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>       beforePrototypeCreation(beanName);<br>       prototypeInstance = createBean(beanName, mbd, args);<br>      &#125;<br>      <span class="hljs-keyword">finally</span> &#123;<br>       afterPrototypeCreation(beanName);<br>      &#125;<br>      beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>     &#125;<br><br>     <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();<br>      <span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);<br>      <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;<br>        beforePrototypeCreation(beanName);<br>        <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>        &#125;<br>        <span class="hljs-keyword">finally</span> &#123;<br>         afterPrototypeCreation(beanName);<br>        &#125;<br>       &#125;);<br>       beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScopeNotActiveException</span>(beanName, scopeName, ex);<br>      &#125;<br>     &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>     beanCreation.tag(<span class="hljs-string">&quot;exception&quot;</span>, ex.getClass().toString());<br>     beanCreation.tag(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(ex.getMessage()));<br>     cleanupAfterBeanCreationFailure(beanName);<br>     <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>     beanCreation.end();<br>     <span class="hljs-keyword">if</span> (!isCacheBeanMetadata()) &#123;<br>      clearMergedBeanDefinition(beanName);<br>     &#125;<br>    &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">return</span> adaptBeanInstance(name, beanInstance, requiredType);<br>  &#125;<br>  <br> &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Into
后打开了一个新的类：<code>DefaultSingletonBeanRegistry</code></p></li>
<li><p>调用了其
<code>public Object getSingleton(String beanName);</code> 方法</p></li>
<li><p>方法中又调用了重载方法，Step Into</p></li>
<li><p>重点来了，这就是 Spring 的三级缓存机制</p></li>
<li><p>获取一个 Bean 先在 <code>singletonObjects</code>
（成品区）中获取，如果没有再到 <code>earlySingletonObjects</code>
（半成品区）中获取，如果没有加锁再从 <code>singletonObjects</code>
（成品区）和 <code>earlySingletonObjects</code>
（半成品区）中找，如果没有再找工厂 <code>singletonFactories</code>
获取组件，获取到后放到 <code>earlySingletonObjects</code>
中，并返回</p></li>
<li><p>为什么要有三级缓存机制？主要为了解决循环依赖的问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSingletonBeanRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleAliasRegistry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SingletonBeanRegistry</span> &#123;<br> <br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">256</span>);<br> <br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br> <br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br><br> <span class="hljs-meta">@Override</span><br> <span class="hljs-meta">@Nullable</span><br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName)</span> &#123;<br>  <span class="hljs-comment">// 来到了这里，Step Into</span><br>  <span class="hljs-comment">// getSingleton 方法仍在当前类中</span><br>  <span class="hljs-keyword">return</span> getSingleton(beanName, <span class="hljs-literal">true</span>);<br> &#125;<br> <br> <span class="hljs-meta">@Nullable</span><br> <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;<br>  <br>  <span class="hljs-comment">// 重点来了，这里就是 Spring 的三级缓存机制</span><br>  <br>  <span class="hljs-comment">// 先进 this.singletonObjects 里找</span><br>  <span class="hljs-comment">// 如果找不到再进 this.earlySingletonObjects 里找</span><br>  <span class="hljs-comment">// 如果再找不到，就加锁防止并发，再进 this.singletonObjects 和 this.earlySingletonObjects 里找</span><br>  <span class="hljs-comment">// 再没有就去 this.singletonFactories 找工厂，从工厂中制造并拿到一个 Bean 后添加到 this.earlySingletonObjects 里面</span><br>  <br>  <span class="hljs-comment">// 为什么要这样做？为了解决循环依赖的问题</span><br>  <span class="hljs-comment">// 什么是循环依赖问题？</span><br>  <br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * 比如：有一个组件 A，在 A 中有一个属性 B 上面有一个 <span class="hljs-doctag">@Autowired</span> 注解，表明要注入的是一个 B 组件</span><br><span class="hljs-comment">   *  而 B 组件中有一个属性 A，属性 A 上面也有一个注解 <span class="hljs-doctag">@Autowired</span>，表明要注入的是一个 A 组件</span><br><span class="hljs-comment">   *  那么 Spring 在创建 A 组件时就需要创建一个 B 组件用于注入，而创建 B 组件时又需要一个 A 组件用于注入，这时候就产生了“循环依赖”问题</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   */</span><br>  <br>  <span class="hljs-comment">// Spring 是如何解决循环依赖问题的呢？</span><br>  <span class="hljs-comment">// 用三级缓存</span><br>  <span class="hljs-comment">// 当创建 A 组件时，需要一个 B 组件，就去 this.singletonObjects 中找</span><br>  <span class="hljs-comment">// 如果没有，就创建 B 组件，此时先把 A 组件先放进 this.earlySingletonObjects 中</span><br>  <span class="hljs-comment">// 在创建 B 组件时候需要一个 A 组件，就去 this.singletonObjects 中找，发现没有，再去 this.earlySingletonObjects 找，找到了，把地址赋上去</span><br>  <span class="hljs-comment">// 此时 B 组件就创建完成了，就把 B 组件放到 this.singletonObjects 中</span><br>  <span class="hljs-comment">// 再把 B 组件注入到 A 的属性中，此时 A 组件也创建完成了</span><br>  <span class="hljs-comment">// 此时把 A 组件也放到 this.singletonObjects 中，就此解决了“循环依赖”问题</span><br>  <br>  <span class="hljs-comment">// Quick check for existing instance without full singleton lock</span><br>  <span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>  <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;<br>   singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>   <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br>     <span class="hljs-comment">// Consistent creation of early reference within full singleton lock</span><br>     singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>     <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>      singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);<br>      <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>       ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-built_in">this</span>.singletonFactories.get(beanName);<br>       <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;<br>        singletonObject = singletonFactory.getObject();<br>        <span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);<br>        <span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>       &#125;<br>      &#125;<br>     &#125;<br>    &#125;<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> singletonObject;<br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>工厂 Bean 的制造晚于普通 Bean 的制造</p></li>
<li><p>Spring
默认没有开启循环引用，需要在配置文件中开启：<code>application.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.main.allow-circular-references</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h4
id="环绕通知记录around-注解">环绕通知记录（<code>@Around 注解</code>）</h4>
<ul>
<li><p>参见官方文档：<a
target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html"
class="uri">https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html</a></p></li>
<li><p>前面的“前置通知、返回通知、异常通知、后置通知”都只是感知，不能修改目标方法的参数、返回值等</p></li>
<li><p>“环绕通知”可以控制目标方法是否执行，修改目标方法参数
、执行结果等</p></li>
<li><p>被 <code>@Around</code> 注解的方法有下面要求：</p>
<ul>
<li><p>The method should declare <code>Object</code> as its return type,
and the first parameter of the method must be of type
<code>ProceedingJoinPoint</code>.Within the body of the advice method,
you must invoke <code>proceed()</code> on the
<code>ProceedingJoinPoint</code> in order for the underlying method to
run. Invoking <code>proceed()</code> without arguments will result in
the caller’s original arguments being supplied to the underlying method
when it is invoked. For advanced use cases, there is an overloaded
variant of the <code>proceed()</code> method which accepts an array of
arguments (<code>Object[]</code>). The values in the array will be used
as the arguments to the underlying method when it is invoked.</p>
<ul>
<li>返回值类型为：<code>Object</code></li>
<li>第一个参数类型为：<code>ProceedingJoinPoint</code></li>
<li>在方法体内要执行 <code>ProceedingJoinPoint</code> 的
<code>proceed()</code>
方法，方法可以传参数，参数类型为：<code>Object[]</code></li>
</ul></li>
</ul></li>
<li><p>环绕通知示例，切面代码：<code>AroundAspect.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AroundAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* org.wind.spring.aop.people.People.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    ;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 环绕通知有固定写法，如下：</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-meta">@Around(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>        <span class="hljs-comment">// 获取目标方法的参数</span><br>        Object[] args = joinPoint.getArgs();<br><br>        <span class="hljs-comment">// 方法前做事情，即前置通知了</span><br>        System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 前置通知&quot;</span>);<br><br>        <span class="hljs-comment">//Object result = joinPoint.proceed(args); // 类似于反射中的 method.invoke();</span><br><br>        <span class="hljs-comment">// 如果想做异常通知则：捕获异常做</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 类似于反射中的 method.invoke();</span><br>            result = joinPoint.proceed(args);<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 返回通知&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;e.getMessage() = &quot;</span> + e.getMessage());<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 异常通知&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 无论正常异常都会有通知，即后置通知</span><br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 后置通知&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 也可以在这里做返回通知</span><br>        <span class="hljs-comment">//System.out.println(&quot;【环绕通知】 -- 返回通知&quot;);</span><br><br>        <span class="hljs-comment">// 可以修改返回结果</span><br>        <span class="hljs-keyword">return</span> result;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><strong>注意</strong>：因为上面的环绕通知代码中用了 try ... catch
...
所以如果环绕通知外再有切面，那么就感知不到异常的发生，就走正常返回通知，而不是异常通知了，这不是我们想要的结果，所以当环绕通知中发生异常时如果想要做异常通知可以用
try ... catch ... 处理，但一定要在 catch
语句块中再把异常抛出去，让外面的切面感知到发生了异常，即环绕通知中的异常必须要抛出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.aop.aspect;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AroundAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* org.wind.spring.aop.people.People.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    ;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 环绕通知有固定写法，如下：</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-meta">@Around(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br><br>        <span class="hljs-comment">// 获取目标方法的参数</span><br>        Object[] args = joinPoint.getArgs();<br><br>        <span class="hljs-comment">// 方法前做事情，即前置通知了</span><br>        System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 前置通知&quot;</span>);<br><br>        <span class="hljs-comment">//Object result = joinPoint.proceed(args); // 类似于反射中的 method.invoke();</span><br><br>        <span class="hljs-comment">// 如果想做异常通知则：捕获异常做</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 类似于反射中的 method.invoke();</span><br>            result = joinPoint.proceed(args);<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 返回通知&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;e.getMessage() = &quot;</span> + e.getMessage());<br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 异常通知&quot;</span>);<br>            <br>            <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 将异常抛出去，让其它切面感知到</span><br>            <br>            <span class="hljs-comment">// 如果当前方法没有 throws Throwable 声明，还要封装一个 RuntimeException</span><br>            <span class="hljs-comment">// throw new RuntimeException(e.getMessage());</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 无论正常异常都会有通知，即后置通知</span><br>            System.out.println(<span class="hljs-string">&quot;【环绕通知】 -- 后置通知&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 也可以在这里做返回通知</span><br>        <span class="hljs-comment">//System.out.println(&quot;【环绕通知】 -- 返回通知&quot;);</span><br><br>        <span class="hljs-comment">// 可以修改返回结果</span><br>        <span class="hljs-keyword">return</span> result;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="spring-事务记录">6. Spring 事务记录</h2>
<ul>
<li>声明式事务：通过注解等方式，告诉框架我要做什么，怎么做，框架就会按意思去做
<ul>
<li>优点：代码量小</li>
<li>缺点：封装过度，排错不容易</li>
</ul></li>
<li>编程式事务：手动写代码实现想要的功能
<ul>
<li>优点：排错容易</li>
<li>缺点：代码量大</li>
</ul></li>
<li>Spring 中用声明式比较多，即注解</li>
</ul>
<h4 id="准备工作">准备工作</h4>
<ul>
<li><p>创建项目，编辑 <code>pom.xml</code> 文件，添加下面代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>创建一个数据库用于学习：<code>spring_tx</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> `spring_tx`;<br><br>USE `spring_tx`;<br><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `account`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `account`  (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;用户id&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>  `age` <span class="hljs-type">int</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;年龄&#x27;</span>,<br>  `balance` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)  <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;余额&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">4</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `account` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;zhangsan&#x27;</span>, <span class="hljs-number">18</span>, <span class="hljs-number">10000.00</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `account` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;lisi&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-number">10000.00</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `account` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;wangwu&#x27;</span>, <span class="hljs-number">16</span>, <span class="hljs-number">10000.00</span>);<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `book`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `book`  (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">&#x27;图书id&#x27;</span>,<br>  `bookName` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图书名&#x27;</span>,<br>  `price` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;单价&#x27;</span>,<br>  `stock` <span class="hljs-type">int</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;库存量&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">4</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `book` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;剑指Java&#x27;</span>, <span class="hljs-number">100.00</span>, <span class="hljs-number">100</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `book` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;剑指大数据&#x27;</span>, <span class="hljs-number">100.00</span>, <span class="hljs-number">100</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `book` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;剑指Offer&#x27;</span>, <span class="hljs-number">100.00</span>, <span class="hljs-number">100</span>);<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>在 spring
配置文件指定数据源等信息：<code>application.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 数据库地址</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/spring_tx</span><br><span class="hljs-comment"># 数据库用户名</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-comment"># 数据库密码</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-comment"># 数据库驱动类名</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br></code></pre></td></tr></table></figure></li>
<li><p>测试数据源对象等：<code>SpringTxApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringTxApplicationTests</span> &#123;<br><br> <span class="hljs-meta">@Autowired</span><br> DataSource dataSource;<br><br> <span class="hljs-meta">@Autowired</span><br> JdbcTemplate jdbcTemplate; <span class="hljs-comment">// 类似于 QueryRunner</span><br><br> <span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>  <span class="hljs-comment">// 获取 connection 对象</span><br>  <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>  <span class="hljs-comment">// 打印</span><br>  System.out.println(<span class="hljs-string">&quot;connection = &quot;</span> + connection);<br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="查询图书记录">查询图书记录</h4>
<ul>
<li><p>创建两个 Bean 用于封装：</p>
<ul>
<li><p><code>Account.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.bean;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">private</span> BigDecimal balance;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>Book.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.bean;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String bookName;<br>    <span class="hljs-keyword">private</span> BigDecimal price;<br>    <span class="hljs-keyword">private</span> Integer stock;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>创建两个 Dao 用于做查询：</p>
<ul>
<li><p><code>AccountDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDao</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>BookDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.BeanPropertyRowMapper;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">// 根据 id 查找图书</span><br>    <span class="hljs-keyword">public</span> Book <span class="hljs-title function_">getBookById</span><span class="hljs-params">(Integer id)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 定义查询图书 sql</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from book where id = ?&quot;</span>;<br><br>        <span class="hljs-comment">// 2. 执行查询语句</span><br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPropertyRowMapper</span>&lt;&gt;(Book.class), id);<br><br>        <span class="hljs-keyword">return</span> book;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>测试：<code>SpringTxApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringTxApplicationTests</span> &#123;<br>    <br> <span class="hljs-meta">@Autowired</span><br> BookDao bookDao;<br> <br> <span class="hljs-meta">@Test</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testQuery</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">Book</span> <span class="hljs-variable">bookById</span> <span class="hljs-operator">=</span> bookDao.getBookById(<span class="hljs-number">1</span>);<br>  System.out.println(<span class="hljs-string">&quot;bookById = &quot;</span> + bookById);<br> &#125;<br> <br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="新增图书记录">新增图书记录</h4>
<ul>
<li><p>修改 <code>BookDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBook</span><span class="hljs-params">(Book book)</span> &#123;<br>        <br>        <span class="hljs-comment">// 1. 定义插入 sql</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into book(bookName, price, stock) values(?, ?, ?)&quot;</span>;<br><br>        <span class="hljs-comment">// 2. 添加数据</span><br>        jdbcTemplate.update(sql, book.getBookName(), book.getPrice(), book.getStock());<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试：<code>SpringTxApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringTxApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    BookDao bookDao;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAdd</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Book</span>();<br>        book.setBookName(<span class="hljs-string">&quot;西游记&quot;</span>);<br>        book.setPrice(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">99.9</span>));<br>        book.setStock(<span class="hljs-number">100</span>);<br><br>        bookDao.addBook(book);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="更改图书库存数量记录">更改图书库存数量记录</h4>
<ul>
<li><p>修改 <code>BookDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">// 更改图书库存</span><br>    <span class="hljs-comment">// num 为要减少的库存量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateBookStock</span><span class="hljs-params">(Integer bookId, Integer num)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update book set stock = stock-? where id = ?&quot;</span>;<br>        jdbcTemplate.update(sql, num, bookId);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试：<code>SpringTxApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringTxApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    BookDao bookDao;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 买了 2 个 4 号图书</span><br>        bookDao.updateBookStock(<span class="hljs-number">4</span>, <span class="hljs-number">2</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="根据图书-id-删除图书记录">根据图书 id 删除图书记录</h4>
<ul>
<li><p>修改 <code>BookDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">// 根据图书 id 删除图书</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBook</span><span class="hljs-params">(Integer bookId)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delete from book where id = ?&quot;</span>;<br>        jdbcTemplate.update(sql, bookId);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试：<code>SpringTxApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring03TxApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    BookDao bookDao;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDelete</span><span class="hljs-params">()</span> &#123;<br>        bookDao.deleteBook(<span class="hljs-number">4</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="根据-username-扣减账户余额记录">根据 username
扣减账户余额记录</h4>
<ul>
<li><p>修改 <code>AccountDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">// 根据 username 扣减账户余额</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateBalanceByUsername</span><span class="hljs-params">(String username, BigDecimal balance)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 定义 sql</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update account set balance = balance - ? where username = ?&quot;</span>;<br>        <span class="hljs-comment">// 2. 执行 sql</span><br>        jdbcTemplate.update(sql, balance, username);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试：<code>AccountDaoTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.AccountDao;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDaoTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    AccountDao accountDao;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdate</span><span class="hljs-params">()</span> &#123;<br>        accountDao.updateBalanceByUsername(<span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;99.9&quot;</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="编写用户购买图书完整方法记录">编写用户购买图书完整方法记录</h4>
<ul>
<li><p>这个方法涉及逻辑，应该在 Service 层，创建一个
<code>UserService</code> 做以上功能：</p>
<ul>
<li><p><code>UserService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">// 结账方法</span><br>    <span class="hljs-comment">// username 哪个用户买</span><br>    <span class="hljs-comment">// bookId 买了哪本书</span><br>    <span class="hljs-comment">// buyNum 买了几本</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkout</span><span class="hljs-params">(String username, Integer bookId, Integer buyNum)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>UserServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.service.impl;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.AccountDao;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.service.UserService;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    BookDao bookDao;<br><br>    <span class="hljs-meta">@Autowired</span><br>    AccountDao accountDao;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkout</span><span class="hljs-params">(String username, Integer bookId, Integer buyNum)</span> &#123;<br>        <span class="hljs-comment">// 0. 先查询图书信息才能做下面的工作</span><br>        <span class="hljs-type">Book</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> bookDao.getBookById(bookId);<br><br>        <span class="hljs-comment">// 书的价格</span><br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> book.getPrice();<br>        <span class="hljs-comment">// 总扣减余额</span><br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(buyNum).multiply(price);<br><br>        <span class="hljs-comment">// 1. 扣减用户余额</span><br>        accountDao.updateBalanceByUsername(username, total);<br><br>        <span class="hljs-comment">// 2. 减少被买书本库存</span><br>        bookDao.updateBookStock(bookId, buyNum);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>测试：<code>AccountDaoTest.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.service.UserService;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDaoTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;<br><br>    <span class="hljs-comment">// 测试结账</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testcheckout</span><span class="hljs-params">()</span> &#123;<br>        userService.checkout(<span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="注解-enabletransactionmanagement-与-transactional-记录">注解
<code>@EnableTransactionManagement</code> 与 <code>@Transactional</code>
记录</h4>
<ul>
<li>上面的代码虽然运行暂时没有问题，但如果在执行过程中出现了异常，那么数据库中的书库存更改了，钱也扣了，因为没有事务，所以也不回滚，就有大问题了！</li>
<li>此时可以用 Spring 的事务注解</li>
<li>在类上标注解 <code>@EnableTransactionManagement</code></li>
<li>在可能发生异常的类或者方法上用 <code>@Transactional</code> 注解</li>
</ul>
<h5 id="注解-transactional-用法细节记录">注解
<code>@Transactional</code> 用法细节记录</h5>
<ul>
<li><p>value：参数类型为 <code>String</code>，同 transactionManager
参数，用于指定一个 TransactionManager Bean 作为事务管理器</p>
<ul>
<li><p><code>TransactionManager</code> 有三个子接口，主要看
<code>PlatformTransactionManager</code> 接口</p></li>
<li><p><code>PlatformTransactionManager</code> 接口中有三个方法，分别为
commit 和 rollback 和 getTransaction</p></li>
<li><p>由此便知事务管理器是负责控制事务的提交和回滚的</p></li>
<li><p>如何知道默认的事务管理器是哪个，在测试中用
<code>@Autowired</code>
注解注入一个再打印便知道了，打印结果为：<code>org.springframework.jdbc.support.JdbcTransactionManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.transaction.TransactionManager;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    TransactionManager transactionManager;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span> <span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;transactionManager = &quot;</span> + transactionManager);<br>        System.out.println(transactionManager.getClass());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>事务的 commit、rollback、getTransaction 方法是由谁调用的呢？</p>
<ul>
<li><code>TransactionManager</code> 控制事务的提交和回滚</li>
<li>而有一个切面 <code>TransactionInterceptor</code>
控制什么时候提交和回滚
<ul>
<li><code>completeTransactionAfterThrowing(txInfo, ex);</code></li>
<li><code>commitTransactionAfterReturning(txInfo);</code></li>
</ul></li>
</ul></li>
</ul></li>
<li><p>transactionManager：同 value 参数</p></li>
<li><p>label：参数类型为 <code>String[]</code>
不常用，用于给事务打标签</p></li>
<li><p><strong>propagation</strong>：参数类型为 <code>Propagation</code>
枚举类型，默认为 <code>Propagation.REQUIRED</code></p>
<ul>
<li><p>传播行为：一个大的事务中有另一个或一些小的事务，是开启一个新的事务？还是合并到大事务中？等等，此时就要控制传播行为</p></li>
<li><p>Spring 中有七种事务的传播行为：</p>
<ul>
<li><strong>REQUIRED</strong>：Support a current transaction, create a
new one if none
exists.（支持当前事务，如果当前没有事务则新建一个事务）有就用，没有就建了再用</li>
<li>SUPPORTS：Support a current transaction, execute non-transactionally
if none
exists.（支持当前事务，如果当前没有事务就直接无事务地执行）有就用，没有就不用了</li>
<li>MANDATORY：Support a current transaction, throw an exception if none
exists.（支持当前事务，如果当前没有事务则抛出异常）有就用，没有就报错</li>
<li><strong>REQUIRES_NEW</strong>：Create a new transaction, and suspend
the current transaction if one
exists.（创建一个新的事务，如果当前有事务，则挂起）有也不用，就要自己新建一个来用</li>
<li>NOT_SUPPORTED：Execute non-transactionally, suspend the current
transaction if one
exists.（直接无事务地执行代码，如果当前有事务，则挂起）有也不用，也不新建一个来用</li>
<li>NEVER：Execute non-transactionally, throw an exception if a
transaction
exists.（直接无事务地执行代码，如果当前有事务，则抛出异常）没有就不用，但有了就报错</li>
<li>NESTED：Execute within a nested transaction if a current transaction
exists, behave like REQUIRED
otherwise.（如果有当前事务，则在当前事务嵌套一个事务执行代码，如果没有就和上面的
REQUIRED 行为一样），可以回滚到保存点</li>
<li>注意区分：REQUIRES_NEW 和 NESTED</li>
</ul></li>
<li><p>分析时一定要注意异常机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">A &#123;<br>    B() &#123;    <span class="hljs-comment">// REQUIRED</span><br>        F()  <span class="hljs-comment">// REQUIRES_NEW</span><br>        G()  <span class="hljs-comment">// REQUIRED</span><br>        H()  <span class="hljs-comment">// REQUIRES_NEW</span><br>    &#125;<br>    C() &#123;    <span class="hljs-comment">// REQUIRES_NEW</span><br>        I()  <span class="hljs-comment">// REQUIRES_NEW</span><br>        J()  <span class="hljs-comment">// REQUIRED</span><br>    &#125;<br>    D() &#123;    <span class="hljs-comment">// REQUIRES_NEW</span><br>        K()  <span class="hljs-comment">// REQUIRES_NEW</span><br>        L()  <span class="hljs-comment">// REQUIRES_NEW    // 点位2异常：K F H C(I,J) 不回滚，E 及下面代码不执行</span><br>    &#125;<br>    E() &#123;    <span class="hljs-comment">// REQUIRED</span><br>        M()  <span class="hljs-comment">// REQUIRED</span><br>        <span class="hljs-comment">// 点位3异常：F H C(I,J) D(K,L) 不回滚，N 及下面代码不执行</span><br>        N()  <span class="hljs-comment">// REQUIRES_NEW</span><br>    &#125;<br>    <br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>/<span class="hljs-number">0</span>;    <span class="hljs-comment">// 点位1异常：C(I,J) D(K,L) F H N 不回滚</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>如果大事务与小事务都设置了属性，那么一定是用大的，比如
timeout</p></li>
</ul></li>
<li><p><strong>isolation</strong>：参数类型为 <code>Isolation</code>
枚举类型，默认为 <code>Isolation.DEFAULT</code></p>
<ul>
<li><p>隔离级别：多个线程并发读取数据库的时候要用到，因为写的时候数据库会加锁，所以都是跟读取有关</p></li>
<li><p>MySQL 默认的隔离级别为：可重复读</p></li>
<li><p>MariaDB 默认的隔离级别为：可重复读</p></li>
<li><p>Oracle 默认的隔离级别为：读已提交</p></li>
<li><p>SQL Server 默认的隔离级别为：读已提交</p></li>
<li><p>SQLite 默认的隔离级别为：串行化</p></li>
<li><p>PostgreSQL 默认的隔离级别为：读已提交</p>
<ul>
<li><p>读未提交（Read
Uncommitted）：读到没有提交的数据，有脏读问题，即读数据的时候，一个线程已经把数据改了，但没有提交，而另一个线程又开始读取数据，那么读到的数据仍然是没有更改之前的数据</p>
<ul>
<li><p>代码示例：</p></li>
<li><p>类 <code>Book.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.bean;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String bookName;<br>    <span class="hljs-keyword">private</span> BigDecimal price;<br>    <span class="hljs-keyword">private</span> Integer stock;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>类 <code>BookDao.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Isolation;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">// 根据 id 查询书本价格</span><br>    <span class="hljs-comment">// 指定事务的隔离级别为“读未提交”</span><br>    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_UNCOMMITTED)</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getBookPriceById</span><span class="hljs-params">(Integer bookId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select price from book where id = ?&quot;</span>;<br>        <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试类 <code>BookDaoTest.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    BookDao bookDao;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testQuery</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bookPrice</span> <span class="hljs-operator">=</span> bookDao.getBookPriceById(<span class="hljs-number">1</span>);<br>        System.out.println(<span class="hljs-string">&quot;bookPrice = &quot;</span> + bookPrice);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>连接数据库，并开启事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 开启事务<br><span class="hljs-keyword">begin</span>;<br># 查看数据库<br><span class="hljs-keyword">show</span> databases;<br># 使用数据库<br>use spring_tx;<br># 查看数据表<br><span class="hljs-keyword">show</span> tables;<br># 查看所有书本信息<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> book;<br># 更改 id 为 <span class="hljs-number">1</span> 的书本价格为 <span class="hljs-number">99.0</span><br><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">99.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>运行测试方法，显示结果为 99.00</p></li>
<li><p>数据库事务再回滚，再查看价格：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 事务回滚<br><span class="hljs-keyword">rollback</span>;<br># 查看所有书本信息<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> book;<br></code></pre></td></tr></table></figure></li>
<li><p>上面就是“读未提交”的脏读，下面再测试不可重复读，修改测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">package</span> org.wind.spring.tx;<br><br>    <span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br>    <span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br>    <span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br>    <span class="hljs-keyword">import</span> org.wind.spring.tx.dao.BookDao;<br><br>    <span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br>    <span class="hljs-meta">@SpringBootTest</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoTest</span> &#123;<br><br>        <span class="hljs-meta">@Autowired</span><br>        BookDao bookDao;<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">testQuery</span><span class="hljs-params">()</span> &#123;<br>&gt;&gt;&gt;            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bookPrice</span> <span class="hljs-operator">=</span> bookDao.getBookPriceById(<span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;bookPrice = &quot;</span> + bookPrice);<br>&gt;&gt;&gt;            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bookPrice1</span> <span class="hljs-operator">=</span> bookDao.getBookPriceById(<span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;bookPrice1 = &quot;</span> + bookPrice1);<br>&gt;&gt;&gt;            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bookPrice2</span> <span class="hljs-operator">=</span> bookDao.getBookPriceById(<span class="hljs-number">1</span>);<br>            System.out.println(<span class="hljs-string">&quot;bookPrice2 = &quot;</span> + bookPrice2);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>开启 Debug 模式：在上面箭头地方打断点</p></li>
<li><p>运行到断点的时候，开启事务，修改价格：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 开启事务<br><span class="hljs-keyword">begin</span>;<br># 修改价格<br><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">90.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 下一步，此时可以看到读取到的 bookPrice 是
90.00</p></li>
<li><p>再修改价格：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">30.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 两次，此时可以看到读取到的 bookPrice1 是 30.00</p></li>
<li><p>再修改价格：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">50.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 两次，此时可以看到读取到的 bookPrice2 是 50.00</p></li>
<li><p>如果此时进行 rollback 那么就是脏读和不重复读了</p></li>
</ul></li>
<li><p>读已提交（Read Committed）：读到已经提交的数据</p>
<ul>
<li><p>更改类 <code>BookDao.java</code> 中的注解
<code>@Transactional</code> 中的参数 isolation 为
<code>Isolation.READ_COMMITTED</code></p></li>
<li><p>再 Debug 测试程序，并开启事务，修改价格：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 开启事务<br><span class="hljs-keyword">begin</span>;<br># 更改价格为 <span class="hljs-number">39</span><br><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">39.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>一直 Step Over 到前两个价格都输出后，发现价格都没有变，都是
100.00</p></li>
<li><p>提交：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 提交事务<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>再次 Step Over 发现第三次读到的价格变成了 39.00</p></li>
</ul></li>
<li><p>可重复读（Repeatable
Read）：同一事务期间多次重复读取的数据相同</p>
<ul>
<li><p>不可重复读代码示例：</p></li>
<li><p>修改类 <code>BookDao.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">package</span> org.wind.spring.tx.dao;<br><br>    <span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br>    <span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br>    <span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br>    <span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Isolation;<br>    <span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br>    <span class="hljs-keyword">import</span> org.wind.spring.tx.bean.Book;<br><br>    <span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br>    <span class="hljs-meta">@Component</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDao</span> &#123;<br><br>        <span class="hljs-meta">@Autowired</span><br>        JdbcTemplate jdbcTemplate;<br><br>        <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span><br>        <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getBookPriceById</span><span class="hljs-params">(Integer bookId)</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select price from book where id = ?&quot;</span>;<br><br>&gt;&gt;&gt;            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal1</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal2</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal3</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal4</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal5</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br><br>            <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, BigDecimal.class, bookId);<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>在上面箭头的地方打断点，运行测试程序，来到断点处，开启事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 开启事务<br><span class="hljs-keyword">begin</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 下一步，bigDecimal1 为 100.00</p></li>
<li><p>修改价格，并提交事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 修改价格为 <span class="hljs-number">60.00</span><br><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">60.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br># 提交事务<br><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>再 Step Over
下一步，发现价格发生了变化，这就是不可重复读</p></li>
<li><p>可重复读示例代码：</p></li>
<li><p>更改类 <code>BookDao.java</code> 中的注解
<code>@Transactional</code> 中的参数 isolation 为
<code>Isolation.REPEATABLE_READ</code></p></li>
<li><p>Step Over 下一步，bigDecimal1 为 100.00</p></li>
<li><p>修改价格，再测试：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 修改价格为 <span class="hljs-number">60.00</span><br><span class="hljs-keyword">update</span> book <span class="hljs-keyword">set</span> price <span class="hljs-operator">=</span> <span class="hljs-number">60.0</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 下一步，读到的价格仍然是 100.00</p></li>
<li><p>提交事务：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">commit</span>;<br></code></pre></td></tr></table></figure></li>
<li><p>Step Over 下一步，读到的价格依然是 100.00</p></li>
<li><p>这就是可重复读</p></li>
</ul></li>
<li><p>串行化（Serializable）：最高隔离级别，完全禁止了并发</p></li>
<li><p>总结表格：o 表示存在的问题，x 表示没有的问题</p>
<table>
<thead>
<tr>
<th>级别/问题</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>读未提交</td>
<td>o</td>
<td>o</td>
<td>o</td>
</tr>
<tr>
<td>读已提交</td>
<td>x</td>
<td>o</td>
<td>o</td>
</tr>
<tr>
<td>可重复读</td>
<td>x</td>
<td>x</td>
<td>o</td>
</tr>
<tr>
<td>串行化</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul></li>
<li><p>timeout：参数类型为 <code>int</code>
用于控制事务的超时时间，时间单位为秒，默认值为底层事务系统的默认超时时间。</p>
<ul>
<li>一但超过指定的时间，事务就会回滚</li>
<li>注意，超时的时间是指从方法开始到最后一次数据库操作的时间，如果最后一次数据库操作没有超时，那么就不算超时</li>
<li>所以才叫指定事务的超时时间，而不是方法的超时时间</li>
</ul></li>
<li><p>timeoutString：参数类型为 <code>String</code> 功能同 timeout
参数，不过参数类型不一样</p></li>
<li><p>readOnly：参数类型为 <code>boolean</code>
用于指定是否全是只读操作的事务，如果是则可以设置为真，可以提升性能</p>
<ul>
<li>如果有增删改就不要设置为真</li>
</ul></li>
<li><p>rollbackFor：参数类型为
<code>Class&lt;? extends Throwable&gt;[]</code>
用于指定当发生指定异常的时候才回滚</p>
<ul>
<li>比如指定当发生了 <code>IOException</code> 才回滚，那么除了指定的
<code>IOException</code> 和运行时异常，其它异常都不会回滚
<ul>
<li><code>@Transactional(rollbackFor = &#123;IOException.class&#125;)</code></li>
</ul></li>
<li>异常分为两大类：
<ul>
<li><p>运行时异常（unchecked exception【受检异常】）</p></li>
<li><p>编译时异常（checked exception【受检异常】）</p></li>
</ul></li>
<li>如果不指定，那么默认发生了 RuntimeException 和 Error
异常就会回滚，即是运行时异常都回滚</li>
<li>如果指定了，那么就是默认+指定的异常都会回滚</li>
</ul></li>
<li><p>rollbackForClassName：参数类型为 <code>String[]</code> 作用同
rollbackFor 参数，不过填写的是异常类的全类名</p></li>
<li><p>noRollbackFor：参数类型为
<code>Class&lt;? extends Throwable&gt;[]</code>
用于指定发生指定异常时不回滚</p>
<ul>
<li>如果不指定，那么默认发生了编译时异常都不回滚</li>
<li>如果指定了，那么就是默认+指定的异常都不回滚</li>
</ul></li>
<li><p>noRollbackForClassName：参数类型为 <code>String[]</code> 作用同
noRollbackFor 参数，不过填写的是异常类的全类名</p></li>
</ul>
<h2 id="补充springboot-测试功能记录">补充：SpringBoot 测试功能记录</h2>
<p>在 SpringBoot 中，可以很方便地进行测试</p>
<p>在 <code>src\test\java</code>
下写测试类：<code>SpringApplicationTests.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring01IocApplicationTests</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>有一个要求，就是测试类要和主类同一个路径下：</p>
<p>比如我的主类在 <code>src\main\java</code>
下：<code>SpringApplicationMain.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.wind.spring;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringApplicationMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>  SpringApplication.run(SpringApplicationMain.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>注意：主类和测试类在同一个路径下：即 org.wind 下</strong></p>
<p>测试组件也很方便，直接 <code>@Autowired</code> 就行了</p>
<h2 id="补充spring-工具类记录">补充：Spring 工具类记录</h2>
<ul>
<li>Spring
有很多工具类可以在反射时用：<code>ClassUtils.java</code>、<code>AnnotationUtils.java</code></li>
</ul>
<h2 id="补充懒汉单例模式记录">补充：懒汉单例模式记录</h2>
<ul>
<li>懒汉单例模式为什么要有两次判断是否为空：保证不会多次创建实例</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonLazy</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> SingletonLazy instance;<br>    <span class="hljs-comment">// 私有构造防止通过 new 实例化对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">SingletonLazy</span><span class="hljs-params">()</span> &#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingletonLazy <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 第一次检查实例对象是否存在，如果不存在才创建</span><br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 多线程并发时，如果上面的条件都成立，就要加锁创建实例</span><br>            <span class="hljs-keyword">synchronized</span> (SingletonLazy.class) &#123;<br>                <span class="hljs-comment">// 加锁后还要判断，如果不判断，那么一个线程创建了实例，锁释放了</span><br>                <span class="hljs-comment">// 而此时另一个线程又创一次实例，就不是懒汉单例模式了</span><br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonLazy</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="补充ioc-容器启动-12-大步记录">补充：IoC 容器启动 12
大步记录</h2>
<ul>
<li><p>由之前的通过配置文件创建容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ioc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;classpath:spring.xml&quot;</span>);<br></code></pre></td></tr></table></figure></li>
<li><p>点开 <code>ClassPathXmlApplicationContext</code>
类，找到构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractXmlApplicationContext</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathXmlApplicationContext</span><span class="hljs-params">(String configLocation)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">// 调用了另一个构造方法，即下面的构造方法</span><br>        <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;configLocation&#125;, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathXmlApplicationContext</span><span class="hljs-params">(</span><br><span class="hljs-params">  String[] configLocations, <span class="hljs-type">boolean</span> refresh, <span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span><br>   <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>  <span class="hljs-built_in">super</span>(parent);<br>  setConfigLocations(configLocations);<br>  <span class="hljs-keyword">if</span> (refresh) &#123;<br>            <span class="hljs-comment">// 注意，在这一步就完成了容器的启动，点进去，打开了一个新的类</span><br>   refresh();<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>类 <code>AbstractApplicationContext</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br>    <span class="hljs-comment">// 以下就是 IoC 容器启动的 12 大步，一个官方注解一大步，共 12 大步</span><br>    <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>  <span class="hljs-built_in">this</span>.startupShutdownLock.lock();<br>  <span class="hljs-keyword">try</span> &#123;<br>   <span class="hljs-built_in">this</span>.startupShutdownThread = Thread.currentThread();<br><br>   <span class="hljs-type">StartupStep</span> <span class="hljs-variable">contextRefresh</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.refresh&quot;</span>);<br><br>   <span class="hljs-comment">// Prepare this context for refreshing.</span><br>   prepareRefresh();<br><br>   <span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br>   <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br>   <span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br>   prepareBeanFactory(beanFactory);<br><br>   <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br>    postProcessBeanFactory(beanFactory);<br><br>    <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanPostProcess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.beans.post-process&quot;</span>);<br>    <span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br>    invokeBeanFactoryPostProcessors(beanFactory);<br>    <span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>    registerBeanPostProcessors(beanFactory);<br>    beanPostProcess.end();<br><br>    <span class="hljs-comment">// Initialize message source for this context.</span><br>    initMessageSource();<br><br>    <span class="hljs-comment">// Initialize event multicaster for this context.</span><br>    initApplicationEventMulticaster();<br><br>    <span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br>    onRefresh();<br><br>    <span class="hljs-comment">// Check for listener beans and register them.</span><br>    registerListeners();<br><br>    <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>    finishBeanFactoryInitialization(beanFactory);<br><br>    <span class="hljs-comment">// Last step: publish corresponding event.</span><br>    finishRefresh();<br>   &#125;<br><br>   <span class="hljs-keyword">catch</span> (RuntimeException | Error ex ) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>     logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br>       <span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>    &#125;<br><br>    <span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>    destroyBeans();<br><br>    <span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>    cancelRefresh(ex);<br><br>    <span class="hljs-comment">// Propagate exception to caller.</span><br>    <span class="hljs-keyword">throw</span> ex;<br>   &#125;<br><br>   <span class="hljs-keyword">finally</span> &#123;<br>    contextRefresh.end();<br>   &#125;<br>  &#125;<br>  <span class="hljs-keyword">finally</span> &#123;<br>   <span class="hljs-built_in">this</span>.startupShutdownThread = <span class="hljs-literal">null</span>;<br>   <span class="hljs-built_in">this</span>.startupShutdownLock.unlock();<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>第 1 步： <code>prepareRefresh</code> 刷新前准备</p></li>
<li><p>第 2 步： <code>obtainFreshBeanFactory</code> 获取一个新的 Bean
工厂</p></li>
<li><p>第 3 步： <code>prepareBeanFactory</code> 准备 Bean
工厂，向其中添加一些必要的组件</p></li>
<li><p>第 4 步： <code>postProcessBeanFactory</code> 允许对 Bean
工厂做一些后置处理</p></li>
<li><p>第 5 步： <code>invokeBeanFactoryPostProcessors</code> 执行 Bean
工厂的后置处理器</p></li>
<li><p>第 6 步：<code>registerBeanPostProcessors</code> 注册 Bean
后置处理器</p>
<ul>
<li><p>点进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>        <span class="hljs-comment">// 再点进去</span><br>        PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再点进 <code>registerBeanPostProcessors</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostProcessorRegistrationDelegate</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">   ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> &#123;<br>        <span class="hljs-comment">// 注意这一步会拿到所有后置处理器的名</span><br>        String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br><br>  <span class="hljs-type">int</span> <span class="hljs-variable">beanProcessorTargetCount</span> <span class="hljs-operator">=</span> beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;<br>  beanFactory.addBeanPostProcessor(<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPostProcessorChecker</span>(beanFactory, postProcessorNames, beanProcessorTargetCount));<br><br>  List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>   <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>                <span class="hljs-comment">// 如果在容器中拿不到 Bean 则创建，所以 getBean 方法还有创建 Bean 的功能</span><br>    <span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>    priorityOrderedPostProcessors.add(pp);<br>    <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>     internalPostProcessors.add(pp);<br>    &#125;<br>   &#125;<br>   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>    orderedPostProcessorNames.add(ppName);<br>   &#125;<br>   <span class="hljs-keyword">else</span> &#123;<br>    nonOrderedPostProcessorNames.add(ppName);<br>   &#125;<br>  &#125;<br><br>  sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);<br><br>  List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(orderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;<br>   <span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>   orderedPostProcessors.add(pp);<br>   <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>    internalPostProcessors.add(pp);<br>   &#125;<br>  &#125;<br>  sortPostProcessors(orderedPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, orderedPostProcessors);<br><br>  List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(nonOrderedPostProcessorNames.size());<br>  <span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;<br>   <span class="hljs-type">BeanPostProcessor</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> beanFactory.getBean(ppName, BeanPostProcessor.class);<br>   nonOrderedPostProcessors.add(pp);<br>   <span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>    internalPostProcessors.add(pp);<br>   &#125;<br>  &#125;<br>  registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);<br><br>  sortPostProcessors(internalPostProcessors, beanFactory);<br>  registerBeanPostProcessors(beanFactory, internalPostProcessors);<br><br>        beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationListenerDetector</span>(applicationContext));<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>第 7 步： <code>initMessageSource</code> 支持 Message
Source（国际化消息）</p></li>
<li><p>第 8 步： <code>initApplicationEventMulticaster</code>
初始化应用事件多播器</p>
<ul>
<li>事件驱动开发 ，从容器中获取类型为
<code>ApplicationEventMulticaster</code> 名字为
<code>applicationEventMulticaster</code> 的组件，没有就新建</li>
<li>后面 SpringBoot 会有</li>
</ul></li>
<li><p>第 9 步： <code>onRefresh</code>
在特定的上下文子类中初始化其他特殊 bean（留给子类的方法）</p></li>
<li><p>第 10 步： <code>registerListeners</code> 注册监听器</p>
<ul>
<li>从容器中获取类型为 <code>ApplicationListener</code> 的组件</li>
</ul></li>
<li><p>第 11 步：
<strong><code>finishBeanFactoryInitialization</code></strong> 完成 Bean
工厂初始化</p>
<ul>
<li><p>Instantiate all remaining (non-lazy-init)
singletons（实例化所有剩余的 非懒加载 的单例组件）</p></li>
<li><p>这一步执行后，容器中所有自己写的 Bean 创建好了</p></li>
<li><p>可以在这一步打一个断点，用 Debug 模式运行后去 beanFactory 看看
singletonObjects 中有没有自己写的
Bean，除了后置处理器创建好了，其它自己写的 Bean 还没有创建好</p></li>
<li><p>Step Into
进去看看，注意最后一步：<code>beanFactory.preInstantiateSingletons();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>  <span class="hljs-comment">// Initialize conversion service for this context.</span><br>  <span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;<br>    beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>   beanFactory.setConversionService(<br>     beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>  &#125;<br><br>  <span class="hljs-comment">// Register a default embedded value resolver if no BeanFactoryPostProcessor</span><br>  <span class="hljs-comment">// (such as a PropertySourcesPlaceholderConfigurer bean) registered any before:</span><br>  <span class="hljs-comment">// at this point, primarily for resolution in annotation attribute values.</span><br>  <span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>   beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>  &#125;<br><br>  <span class="hljs-comment">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br>  String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>   <span class="hljs-keyword">try</span> &#123;<br>    beanFactory.getBean(weaverAwareName, LoadTimeWeaverAware.class);<br>   &#125;<br>   <span class="hljs-keyword">catch</span> (BeanNotOfRequiredTypeException ex) &#123;<br>    <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>     logger.debug(<span class="hljs-string">&quot;Failed to initialize LoadTimeWeaverAware bean &#x27;&quot;</span> + weaverAwareName +<br>       <span class="hljs-string">&quot;&#x27; due to unexpected type mismatch: &quot;</span> + ex.getMessage());<br>    &#125;<br>   &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Stop using the temporary ClassLoader for type matching.</span><br>  beanFactory.setTempClassLoader(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-comment">// Allow for caching all bean definition metadata, not expecting further changes.</span><br>  beanFactory.freezeConfiguration();<br><br>     <span class="hljs-comment">// 实例化所有剩余的 非懒加载 的单例组件</span><br>  <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>  beanFactory.preInstantiateSingletons();<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再 Step Into 进去 <code>preInstantiateSingletons</code>
方法看看，获取所有的 beanNames 放到集合中，再进行两次 for 循环创建
Bean，其中第一个 for 循环是初始化所有非懒加载的 beans，第二个 for
循环是触发所有的后置处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;serial&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultListableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractAutowireCapableBeanFactory</span><br>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableListableBeanFactory</span>, BeanDefinitionRegistry, Serializable &#123;<br>    <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>  <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>   logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-built_in">this</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><br>  <span class="hljs-comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><br>  List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.beanDefinitionNames);<br><br>  <span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span><br>  <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>   <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>            <span class="hljs-comment">// 如果 bean 不是抽象和是单例和非懒加载的就进行初始化</span><br>   <span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br>                <span class="hljs-comment">// 如果是 FactoryBean 就用 FactoryBean 的创建法</span><br>    <span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<br>     <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);<br>     <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> SmartFactoryBean&lt;?&gt; smartFactoryBean &amp;&amp; smartFactoryBean.isEagerInit()) &#123;<br>      getBean(beanName);<br>     &#125;<br>    &#125;<br>                <span class="hljs-comment">// 否则是普通 Bean 就用 getBean 创建 Bean</span><br>                <span class="hljs-comment">// 所以 getBean 有两个功能：</span><br>                <span class="hljs-comment">//     1. 获取 Bean</span><br>                <span class="hljs-comment">//     2. 创建 Bean</span><br>    <span class="hljs-keyword">else</span> &#123;<br>     getBean(beanName);<br>    &#125;<br>   &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Trigger post-initialization callback for all applicable beans...</span><br>  <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>   <span class="hljs-type">Object</span> <span class="hljs-variable">singletonInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);<br>   <span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton smartSingleton) &#123;<br>    <span class="hljs-type">StartupStep</span> <span class="hljs-variable">smartInitialize</span> <span class="hljs-operator">=</span> getApplicationStartup().start(<span class="hljs-string">&quot;spring.beans.smart-initialize&quot;</span>)<br>      .tag(<span class="hljs-string">&quot;beanName&quot;</span>, beanName);<br>    smartSingleton.afterSingletonsInstantiated();<br>    smartInitialize.end();<br>   &#125;<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>如果再往下：<code>doGetBean</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> &#123;<br>    <br> <span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>  <span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再往下，从三级缓存中没有获取到对象，走 else 分支，调用
<code>createBean</code> 方法创建 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FactoryBeanRegistrySupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> &#123;<br><br>        <span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span><br><span class="hljs-params">                String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span><br>                <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>            <span class="hljs-comment">// 省略代码</span><br>            <span class="hljs-comment">// ...</span><br><br>            <span class="hljs-comment">// 从三级缓存中没有获取到对象走到这里</span><br>            <span class="hljs-keyword">else</span> &#123;<br><br>                <span class="hljs-comment">// 省略代码</span><br>                <span class="hljs-comment">// ...</span><br><br>                <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>                    <span class="hljs-comment">// 标记 Bean 是要创建的</span><br>                    markBeanAsCreated(beanName);<br>                &#125;<br><br>                <span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanCreation</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.beans.instantiate&quot;</span>)<br>                        .tag(<span class="hljs-string">&quot;beanName&quot;</span>, name);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;<br>                        beanCreation.tag(<span class="hljs-string">&quot;beanType&quot;</span>, requiredType::toString);<br>                    &#125;<br>                    <span class="hljs-comment">// 拿到 Bean 的定义信息</span><br>                    <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>                    checkMergedBeanDefinition(mbd, beanName, args);<br><br>                    <span class="hljs-comment">// 如果 Bean 有依赖其它 Bean 先造依赖的 Bean</span><br>                    <span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span><br>                    String[] dependsOn = mbd.getDependsOn();<br>                    <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// 省略代码</span><br>                        <span class="hljs-comment">// ...</span><br>                    &#125;<br><br>                    <span class="hljs-comment">// 真正开始创建 Bean 实例对象</span><br>                    <span class="hljs-comment">// Create bean instance.</span><br>                    <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                        sharedInstance = getSingleton(beanName, () -&gt; &#123;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                <span class="hljs-comment">// 这一步创建 Bean</span><br>&gt;&gt;&gt;                             <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>                            &#125;<br>                            <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>                                <span class="hljs-comment">// 省略代码</span><br>                          <span class="hljs-comment">// ...</span><br>                            &#125;<br>                        &#125;);<br>                        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>                    &#125;<br><br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>                        <span class="hljs-comment">// 省略代码</span><br>                        <span class="hljs-comment">// ...</span><br>                    &#125;<br><br>                    <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 省略代码</span><br>                        <span class="hljs-comment">// ...</span><br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>                    <span class="hljs-comment">// 省略代码</span><br>                    <span class="hljs-comment">// ...</span><br>                &#125;<br>                <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// 省略代码</span><br>                    <span class="hljs-comment">// ...</span><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> adaptBeanInstance(name, beanInstance, requiredType);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再往下，在 <code>createBean</code> 中再调用
<code>resolveBeforeInstantiation</code> 方法调用后置处理器，再调用
<code>doCreateBean</code> 方法创建 Bean，并放到
<code>earlySingletonObjects</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractAutowireCapableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractBeanFactory</span><br>            <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutowireCapableBeanFactory</span> &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br>                <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbdToUse</span> <span class="hljs-operator">=</span> mbd;<br><br>            Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br>            <span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-literal">null</span>) &#123;<br>                mbdToUse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(mbd);<br>                mbdToUse.setBeanClass(resolvedClass);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    mbdToUse.prepareMethodOverrides();<br>                &#125;<br>                <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),<br>                            beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 执行后置处理器方法，即下面的方法</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);<br>                <span class="hljs-comment">// 此时还没有 Bean 对象</span><br>                <span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> bean;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>    <span class="hljs-comment">// 省略代码</span><br>                <span class="hljs-comment">// ...</span><br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 这个才是真正的创建 Bean</span><br>&gt;&gt;&gt;             <span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> doCreateBean(beanName, mbdToUse, args);<br>                <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                    logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">return</span> beanInstance;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;<br>                <span class="hljs-comment">// 省略代码</span><br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-comment">// 省略代码</span><br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span><br>   <span class="hljs-keyword">throws</span> BeanCreationException &#123;<br><br>            <span class="hljs-comment">// Instantiate the bean.</span><br>            <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 真正创建 Bean 实例</span><br>&gt;&gt;&gt;             instanceWrapper = createBeanInstance(beanName, mbd, args);<br>            &#125;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();<br>            Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>            <span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>                mbd.resolvedTargetType = beanType;<br>            &#125;<br><br>            <span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span><br>            <span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br>                <span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,<br>                                <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>                    &#125;<br>                    mbd.markAsPostProcessed();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span><br>            <span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;<br>                    isSingletonCurrentlyInCreation(beanName));<br>            <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>                <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                    logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +<br>                            <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>                &#125;<br>                <span class="hljs-comment">// 添加到 earlySingletonObjects 中</span><br>                addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>            &#125;<br><br>            <span class="hljs-comment">// Initialize the bean instance.</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;<br>            <span class="hljs-keyword">try</span> &#123;<br>                populateBean(beanName, mbd, instanceWrapper);<br>                exposedObject = initializeBean(beanName, exposedObject, mbd);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException bce &amp;&amp; beanName.equals(bce.getBeanName())) &#123;<br>                    <span class="hljs-keyword">throw</span> bce;<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName, ex.getMessage(), ex);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> getSingleton(beanName, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>                        exposedObject = earlySingletonReference;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>                        String[] dependentBeans = getDependentBeans(beanName);<br>                        Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);<br>                        <span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br>                            <span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>                                actualDependentBeans.add(dependentBean);<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName,<br>                                    <span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>                                    StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br>                                    <span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br>                                    <span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br>                                    <span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br>                                    <span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// Register bean as disposable.</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>                        mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> exposedObject;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure></li>
<li><p>再往下，把创建好的实例添加到 singletonObjects 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">package</span> org.springframework.beans.factory.support;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSingletonBeanRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleAliasRegistry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SingletonBeanRegistry</span> &#123;<br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> &#123;<br>            Assert.notNull(beanName, <span class="hljs-string">&quot;Bean name must not be null&quot;</span>);<br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>                <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.singletonsCurrentlyInDestruction) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationNotAllowedException</span>(beanName,<br>                                <span class="hljs-string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> +<br>                                <span class="hljs-string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>                        logger.debug(<span class="hljs-string">&quot;Creating shared instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                    &#125;<br>                    beforeSingletonCreation(beanName);<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">newSingleton</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">recordSuppressedExceptions</span> <span class="hljs-operator">=</span> (<span class="hljs-built_in">this</span>.suppressedExceptions == <span class="hljs-literal">null</span>);<br>                    <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>                        <span class="hljs-built_in">this</span>.suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>                    &#125;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        singletonObject = singletonFactory.getObject();<br>                        newSingleton = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>                        <span class="hljs-comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span><br>                        <span class="hljs-comment">// if yes, proceed with it since the exception indicates that state.</span><br>                        singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);<br>                        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> ex;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;<br>                        <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>                            <span class="hljs-keyword">for</span> (Exception suppressedException : <span class="hljs-built_in">this</span>.suppressedExceptions) &#123;<br>                                ex.addRelatedCause(suppressedException);<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">throw</span> ex;<br>                    &#125;<br>                    <span class="hljs-keyword">finally</span> &#123;<br>                        <span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;<br>                            <span class="hljs-built_in">this</span>.suppressedExceptions = <span class="hljs-literal">null</span>;<br>                        &#125;<br>                        afterSingletonCreation(beanName);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (newSingleton) &#123;<br>                        <span class="hljs-comment">// 把实例添加到 singletonObjects 中</span><br>&gt;&gt;&gt;                     addSingleton(beanName, singletonObject);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span> singletonObject;<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSingleton</span><span class="hljs-params">(String beanName, Object singletonObject)</span> &#123;<br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;<br>                <span class="hljs-comment">// 添加 Bean 实例到 singletonObjects 中</span><br>                <span class="hljs-built_in">this</span>.singletonObjects.put(beanName, singletonObject);<br>                <span class="hljs-comment">// 从 singletonFactories 中移除</span><br>                <span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);<br>                <span class="hljs-comment">// 从 earlySingletonObjects 中移除</span><br>                <span class="hljs-built_in">this</span>.earlySingletonObjects.remove(beanName);<br>                <span class="hljs-built_in">this</span>.registeredSingletons.add(beanName);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure></li>
</ul></li>
<li><p>第 12 步： <code>finishRefresh</code> 完成容器刷新</p></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/tags/Spring/" class="print-no-link">#Spring</a>
      
        <a href="/tags/SpringBoot/" class="print-no-link">#SpringBoot</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring 记录（基于 SpringBoot）</div>
      <div>https://windzwindy.github.io/2025/02/23/Spring_Record/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>windzwindy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年2月23日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年2月23日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/02/23/MyBatis_Record/" title="MyBatis 记录">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MyBatis 记录</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/02/23/SpringMVC_Record/" title="SpringMVC 记录（基于 SpringBoot）">
                        <span class="hidden-mobile">SpringMVC 记录（基于 SpringBoot）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    
      <script  src="/js/img-lazyload.js" ></script>
    
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
